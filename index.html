<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nebula Arcade</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.2/dist/umd/supabase.min.js"></script>
<style>
:root{--grad1:#ff8a00;--grad2:#ffd200;--text:#1b1f24;--border:#e5e7eb;--muted:#6b7280;--bg:#fff;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui;background:var(--bg);color:var(--text);}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:20;}
.logo{font-family:"Fredoka One";font-size:22px;background:linear-gradient(90deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.userMenu{position:relative;}
.userBtn{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;font-weight:700;cursor:pointer;transition:.2s;}
.userBtn:hover{filter:brightness(1.05);}
.avatar{width:28px;height:28px;border-radius:50%;background:#fff;color:#2a2000;display:flex;align-items:center;justify-content:center;font-family:"Fredoka One";}
.dropdown{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.1);display:none;flex-direction:column;min-width:180px;overflow:hidden;z-index:30;}
.dropdown button{background:none;border:0;text-align:left;padding:10px 16px;cursor:pointer;font-weight:600;color:var(--text);transition:.15s;width:100%;}
.dropdown button:hover{background:#f9f9f9;}
main{max-width:1000px;margin:24px auto 90px;padding:0 18px;}
.searchBox{margin-bottom:18px;display:flex;gap:10px;}
.searchBox input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:15px;}
.searchBox input:focus{border-color:#ffd24d;outline:none;box-shadow:0 0 0 4px #ffe08d60;}
.gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
.gameCard{border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:12px;transition:.2s;cursor:pointer;display:flex;flex-direction:column;gap:8px;}
.gameCard:hover{transform:translateY(-3px);}
.cardTitle{font-weight:800}
.cardPreview{width:100%;height:140px;border:0;border-radius:10px;background:#f3f3f3;}
.metaMuted{color:var(--muted);font-size:13px}
.hidden{display:none;}
.wrapAuth{max-width:420px;margin:10vh auto;padding:24px;border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 26px rgba(0,0,0,.06);background:#fff;}
input{width:100%;padding:12px;margin:6px 0;border:1px solid var(--border);border-radius:12px;font-size:15px}
input:focus{box-shadow:0 0 0 4px #ffe08d60;border-color:#ffd24d;outline:none}
.btn{border:0;border-radius:12px;padding:12px 20px;font-weight:800;cursor:pointer;color:#2a2000;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:.15s}
.btn:hover{background:linear-gradient(90deg,#ffa12b,#ffe04d);transform:translateY(-1px)}
.error{color:#b91c1c;font-size:14px;margin-top:6px;text-align:center}
.status{color:#2563eb;font-size:14px;margin-top:6px;text-align:center}
.loader{display:inline-block;width:16px;height:16px;border:3px solid #ffd24d;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.link{color:var(--muted);font-size:14px;text-decoration:underline;cursor:pointer;text-align:center;display:block;margin-top:12px}
.profileView{max-width:700px;margin:0 auto;}
.profileHeader{text-align:center;margin-bottom:16px}
.profileAvatar{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:flex;align-items:center;justify-content:center;color:#2a2000;font-family:"Fredoka One";font-size:40px;margin:0 auto 10px;}
.stats{display:flex;justify-content:center;gap:40px;margin:12px 0;color:var(--muted);}
.gamePage{max-width:900px;margin:0 auto;}
.previewLarge{width:100%;height:380px;border:0;border-radius:14px;background:#f3f3f3;}
.fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a2000;background:linear-gradient(135deg,var(--grad1),var(--grad2));box-shadow:0 10px 24px rgba(255,138,0,.35);cursor:pointer;z-index:25;}
.fab:hover{transform:translateY(-2px)}
</style>
</head>
<body>

<header id="topbar" class="hidden">
  <div class="logo">Nebula Arcade</div>
  <div class="userMenu" id="userMenu">
    <div class="userBtn" id="userBtn">
      <div class="avatar" id="userAvatar">?</div>
      <span id="userNameTop">Cuenta</span>
    </div>
    <div class="dropdown" id="dropdown">
      <button id="viewProfileBtn">üë§ Ver perfil</button>
      <button id="logoutBtn">üö™ Cerrar sesi√≥n</button>
      <button id="deleteBtn" style="color:#b91c1c;display:none;">üóëÔ∏è Eliminar cuenta</button>
    </div>
  </div>
</header>

<!-- LOGIN / REGISTRO -->
<div class="wrapAuth" id="authView">
  <h1 style="font-family:'Fredoka One';text-align:center;">Nebula Arcade</h1>
  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="loginPass" type="password" placeholder="Contrase√±a">
    <button id="loginBtn" class="btn" style="width:100%">Iniciar sesi√≥n</button>
    <div id="loginStatus" class="status hidden"></div>
    <div id="loginError" class="error"></div>
    <span id="showSignup" class="link">¬øNo tienes cuenta? Reg√≠strate</span>
  </div>
  <div id="signupForm" class="hidden">
    <input id="nick" type="text" placeholder="Nombre o nickname">
    <input id="signupEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="signupPass" type="password" placeholder="Contrase√±a (m√≠n. 6)">
    <button id="signupBtn" class="btn" style="width:100%">Registrarse</button>
    <div id="signupStatus" class="status hidden"></div>
    <div id="signupError" class="error"></div>
    <span id="showLogin" class="link">¬øYa tienes cuenta? Inicia sesi√≥n</span>
  </div>
</div>

<!-- APP -->
<main id="appView" class="hidden">
  <div id="homeView">
    <div class="searchBox">
      <input id="searchInput" type="text" placeholder="Buscar juegos por nombre...">
    </div>
    <div class="gamesGrid" id="gamesGrid"></div>
  </div>

  <div id="profileView" class="hidden profileView">
    <div class="profileHeader">
      <div class="profileAvatar" id="profileAvatar">?</div>
      <h2 id="profileName">Usuario</h2>
      <div class="stats">
        <div>‚ù§Ô∏è <span id="likesCount">0</span> Likes</div>
        <div>üëÅÔ∏è <span id="visitsCount">0</span> Visitas</div>
      </div>
    </div>
    <h3 style="text-align:center;margin-bottom:8px;">Juegos subidos</h3>
    <div class="gamesGrid" id="userGamesGrid"></div>
    <div style="text-align:center;margin-top:16px;">
      <button id="backHomeBtn" class="btn" style="width:auto;">üè† Volver al inicio</button>
    </div>
  </div>
</main>

<!-- FAB -->
<button id="fab" class="fab hidden" title="Subir juego">+</button>

<script>
const SUPA_URL="https://arypwvzmjedlhsrzrgxw.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeXB3dnptamVkbGhzcnpyZ3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzgwNDgsImV4cCI6MjA3NTc1NDA0OH0.oLuc_NKB2xh0-43clDOSP0ShISP9shjdrSJgd0jo0uY";
const supabase=window.supabase.createClient(SUPA_URL,SUPA_KEY);

const $=id=>document.getElementById(id);
const loginForm=$("loginForm"),signupForm=$("signupForm"),authView=$("authView"),appView=$("appView"),topbar=$("topbar");
const loginEmail=$("loginEmail"),loginPass=$("loginPass"),loginBtn=$("loginBtn"),loginError=$("loginError"),loginStatus=$("loginStatus");
const signupBtn=$("signupBtn"),signupError=$("signupError"),signupStatus=$("signupStatus"),nick=$("nick"),signupEmail=$("signupEmail"),signupPass=$("signupPass");
const showSignup=$("showSignup"),showLogin=$("showLogin");

showSignup.onclick=()=>{loginForm.classList.add("hidden");signupForm.classList.remove("hidden");};
showLogin.onclick=()=>{signupForm.classList.add("hidden");loginForm.classList.remove("hidden");};

// --- Registro con loader y mensajes detallados ---
signupBtn.onclick=async()=>{
  const nickname=nick.value.trim(), email=signupEmail.value.trim(), pass=signupPass.value;
  signupError.textContent=""; signupStatus.textContent=""; signupStatus.classList.remove("hidden");
  if(!nickname||!email||!pass){ signupError.textContent="Completa todos los campos."; signupStatus.classList.add("hidden"); return;}
  if(pass.length<6){ signupError.textContent="La contrase√±a debe tener al menos 6 caracteres."; signupStatus.classList.add("hidden"); return;}
  signupStatus.innerHTML='<span class="loader"></span>Creando cuenta...';
  try{
    const {data,error}=await supabase.auth.signUp({email,password:pass,options:{data:{nickname}}});
    signupStatus.classList.add("hidden");
    if(error){ signupError.textContent="Error: "+error.message; return;}
    if(data?.user?.identities?.length===0){ signupError.textContent="El correo ya est√° registrado."; return;}
    signupError.style.color="#22c55e"; signupError.textContent="‚úÖ Cuenta creada correctamente.";
  }catch(e){ signupError.textContent="Error inesperado: "+e.message; signupStatus.classList.add("hidden"); }
};

// --- Login con loader y mensajes detallados ---
loginBtn.onclick=async()=>{
  const email=loginEmail.value.trim(), pass=loginPass.value;
  loginError.textContent=""; loginStatus.textContent=""; loginStatus.classList.remove("hidden");
  if(!email||!pass){ loginError.textContent="Rellena ambos campos."; loginStatus.classList.add("hidden"); return;}
  loginStatus.innerHTML='<span class="loader"></span>Verificando credenciales...';
  try{
    const {data,error}=await supabase.auth.signInWithPassword({email,password:pass});
    loginStatus.classList.add("hidden");
    if(error){
      if(error.message.includes("Invalid login credentials")) loginError.textContent="‚ùå Credenciales incorrectas.";
      else loginError.textContent="‚ö†Ô∏è "+error.message;
      return;
    }
    if(!data?.user){ loginError.textContent="‚ö†Ô∏è No se recibi√≥ usuario en la respuesta."; return;}
    await loadUser(); await loadGames();
  }catch(e){ loginError.textContent="Error inesperado: "+e.message; loginStatus.classList.add("hidden"); }
};

supabase.auth.onAuthStateChange(async (_e,session)=>{
  if(session){ await loadUser(); await loadGames(); } else { showAuth(); }
});

async function loadUser(){
  const {data:{user}}=await supabase.auth.getUser();
  if(!user){ showAuth(); return;}
  currentUser=user;
  $("userAvatar").textContent=(user.user_metadata?.nickname||user.email)[0].toUpperCase();
  $("userNameTop").textContent=user.user_metadata?.nickname||user.email;
  showApp();
}

function showAuth(){authView.classList.remove("hidden");appView.classList.add("hidden");topbar.classList.add("hidden");}
function showApp(){authView.classList.add("hidden");appView.classList.remove("hidden");topbar.classList.remove("hidden");}
</script>
</body>
</html>
