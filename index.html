<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nebula Arcade</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --grad1:#ff8a00;--grad2:#ffd200;--text:#1b1f24;--border:#e5e7eb;--muted:#6b7280;--bg:#fff;
  --ok:#16a34a;--warn:#b91c1c;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui;background:var(--bg);color:var(--text);}

/* Topbar */
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:20;backdrop-filter:saturate(1.1) blur(4px)}
.logo{font-family:"Fredoka One";font-size:22px;background:linear-gradient(90deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.userMenu{position:relative;}
.userBtn{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;font-weight:700;cursor:pointer;transition:.2s;box-shadow:0 8px 18px rgba(255,138,0,.25);transform:translateZ(0)}
.userBtn:hover{filter:brightness(1.06);transform:translateY(-1px)}
.userBtn:active{transform:translateY(0)}
.avatar{width:28px;height:28px;border-radius:50%;background:#fff;color:#2a2000;display:flex;align-items:center;justify-content:center;font-family:"Fredoka One"; box-shadow:0 2px 8px rgba(0,0,0,.12);overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.dropdown{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.15);display:none;flex-direction:column;min-width:200px;overflow:hidden;z-index:30}
.dropdown button{background:none;border:0;text-align:left;padding:12px 16px;cursor:pointer;font-weight:600;color:var(--text);transition:.15s;width:100%}
.dropdown button:hover{background:#fafafa}

/* Main & grids */
main{max-width:1000px;margin:24px auto 90px;padding:0 18px}
.searchBox{margin-bottom:12px;display:flex;gap:10px}
.searchBox input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:15px;transition:.15s}
.searchBox input:focus{border-color:#ffd24d;outline:none;box-shadow:0 0 0 4px #ffe08d60}

/* Filtros */
.filters{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.chipBtn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-weight:800;cursor:pointer;transition:.15s}
.chipBtn:hover{background:#fafafa}
.chipBtn.active{border:0;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;box-shadow:0 8px 18px rgba(255,138,0,.25)}

.gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.gameCard{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 10px 26px rgba(0,0,0,.06);padding:12px;transition:.2s;cursor:pointer;display:flex;flex-direction:column;gap:8px;transform:translateZ(0)}
.gameCard:hover{transform:translateY(-4px)}
.cardTitle{font-weight:800}
.cardPreview{width:100%;height:140px;border:0;border-radius:12px;background:#f3f3f3;pointer-events:none}
.metaMuted{color:var(--muted);font-size:13px}
.hidden{display:none}
.loadMoreWrap{display:flex;justify-content:center;margin-top:14px}
.loadMore{border:1px solid var(--border);background:#fff;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
.loadMore:hover{background:#fafafa}

/* Mini avatars en tarjetas */
.miniAvatar{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#f5f5f5;color:#111;font-weight:900;font-size:11px;vertical-align:-3px;margin-right:6px;overflow:hidden}
.miniAvatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}

/* Auth */
.wrapAuth{max-width:420px;margin:10vh auto;padding:24px;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);background:#fff}
input{width:100%;padding:12px;margin:6px 0;border:1px solid var(--border);border-radius:12px;font-size:15px;transition:.15s}
input:focus{box-shadow:0 0 0 4px #ffe08d60;border-color:#ffd24d;outline:none}
.btn{border:0;border-radius:12px;padding:12px 20px;font-weight:800;cursor:pointer;color:#2a2000;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:.15s;box-shadow:0 8px 18px rgba(255,138,0,.25);transform:translateZ(0)}
.btn:hover{background:linear-gradient(90deg,#ffa12b,#ffe04d);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn--danger{background:linear-gradient(90deg,#ff6961,#ffd200)}
.error{color:#b91c1c;font-size:14px;margin-top:6px;text-align:center;white-space:pre-line}
.status{color:#2563eb;font-size:14px;margin-top:6px;text-align:center;white-space:pre-line}
.loader{display:inline-block;width:16px;height:16px;border:3px solid #ffd24d;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
.link{color:var(--muted);font-size:14px;text-decoration:underline;cursor:pointer;text-align:center;display:block;margin-top:12px}

/* Perfil */
.profileView{max-width:700px;margin:0 auto}
.profileHeader{text-align:center;margin-bottom:16px}
.profileAvatar{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:flex;align-items:center;justify-content:center;color:#2a2000;font-family:"Fredoka One";font-size:40px;margin:0 auto 10px;box-shadow:0 10px 22px rgba(255,138,0,.25);overflow:hidden}
.profileAvatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.stats{display:flex;justify-content:center;gap:40px;margin:12px 0;color:var(--muted)}

/* P√°gina de juego */
.gamePage{max-width:900px;margin:0 auto}
.previewLarge{width:100%;height:380px;border:0;border-radius:14px;background:#f3f3f3;pointer-events:none;box-shadow:0 12px 28px rgba(0,0,0,.08)}
.gameHeader{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.gameActions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.toggleBtn{position:relative}
.toggleBtn.active::after{content:"";position:absolute;inset:-3px;border-radius:14px;box-shadow:0 0 0 3px #ffe08da6;pointer-events:none}

.creatorRow{display:flex;align-items:center;gap:8px}
.creatorAvatar{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#fff;color:#111;font-weight:900;overflow:hidden}
.creatorAvatar img{width:100%;height:100%;object-fit:cover;border-radius:50%}

/* Clickable counters */
.countClickable{cursor:pointer;font-weight:800}
.countClickable:hover{text-decoration:underline}

/* FAB subir juego */
.fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a2000;background:linear-gradient(135deg,var(--grad1),var(--grad2));box-shadow:0 12px 28px rgba(0,0,0,.35);cursor:pointer;z-index:25}
.fab:hover{transform:translateY(-2px)}

/* Uploader */
.uploader{max-width:900px;margin:0 auto}
.tabbar{display:flex;gap:10px;margin-top:10px}
.tabbar button{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s;
  font-family:"Fredoka One", system-ui, sans-serif;}
.tabbar button.active{background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;border:0;box-shadow:0 8px 18px rgba(255,138,0,.25)}
.editor{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:14px}
.previewEdit{width:100%;height:260px;border:0;border-radius:12px;background:#f3f3f3}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.counter{color:var(--muted);font-size:13px;margin-left:auto}

/* Fullscreen Player */
.playerFS{position:fixed;inset:0;background:#000;display:none;z-index:60}
.fsFrame{position:absolute;inset:0;width:100%;height:100%;border:0}
.fsClose{position:absolute;top:12px;right:12px;border:0;border-radius:999px;background:rgba(255,255,255,.9);color:#111;padding:8px 12px;font-weight:900;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.35)}
.fsClose:hover{background:#fff}

/* MODAL votantes */
.modalOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:80;align-items:center;justify-content:center}
.modalBox{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:18px;width:92%;max-width:460px;max-height:72vh;overflow:auto}
.votersList{display:flex;flex-direction:column;gap:8px}
.voterItem{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:10px;padding:8px;cursor:pointer}
.voterItem:hover{background:#fafafa}

/* Anim */
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header id="topbar" class="hidden">
  <div class="logo">Nebula Arcade</div>
  <div class="userMenu" id="userMenu">
    <div class="userBtn" id="userBtn">
      <div class="avatar" id="userAvatar">?</div>
      <span id="userNameTop">Cuenta</span>
    </div>
    <div class="dropdown" id="dropdown">
      <button id="viewProfileBtn" type="button">üë§ Ver perfil</button>
      <button id="logoutBtn" type="button">üö™ Cerrar sesi√≥n</button>
      <button id="deleteBtn" type="button" style="color:#b91c1c;display:none;">üóëÔ∏è Eliminar cuenta</button>
    </div>
  </div>
</header>

<!-- LOGIN / REGISTRO -->
<div class="wrapAuth" id="authView">
  <h1 style="font-family:'Fredoka One';text-align:center;">Nebula Arcade</h1>
  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="loginPass" type="password" placeholder="Contrase√±a">
    <button id="loginBtn" class="btn" style="width:100%" type="button">Iniciar sesi√≥n</button>
    <div id="loginStatus" class="status hidden"></div>
    <div id="loginError" class="error"></div>
    <span id="showSignup" class="link">¬øNo tienes cuenta? Reg√≠strate</span>
  </div>
  <div id="signupForm" class="hidden">
    <input id="nick" type="text" placeholder="Nombre o nickname">
    <input id="signupEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="signupPass" type="password" placeholder="Contrase√±a (m√≠n. 6)">
    <button id="signupBtn" class="btn" style="width:100%" type="button">Registrarse</button>
    <div id="signupStatus" class="status hidden"></div>
    <div id="signupError" class="error"></div>
    <span id="showLogin" class="link">¬øYa tienes cuenta? Inicia sesi√≥n</span>
  </div>
</div>

<!-- APP -->
<main id="appView" class="hidden">

  <!-- HOME -->
  <div id="homeView">
    <div class="searchBox">
      <input id="searchInput" type="text" placeholder="Buscar juegos por nombre...">
    </div>

    <!-- Filtros -->
    <div class="filters">
      <button class="chipBtn" id="fPopular" type="button" data-filter="popular">Populares</button>
      <button class="chipBtn" id="fNew" type="button" data-filter="new">Nuevos</button>
      <button class="chipBtn" id="fClassic" type="button" data-filter="classic">Cl√°sicos</button>
      <button class="chipBtn" id="fNebula" type="button" data-filter="nebula">De Nebula Glow</button>
    </div>

    <div class="gamesGrid" id="gamesGrid"></div>
    <div class="loadMoreWrap" id="loadMoreWrap" style="display:none">
      <button id="loadMoreBtn" class="loadMore" type="button">Cargar m√°s</button>
    </div>
  </div>

  <!-- PERFIL -->
  <div id="profileView" class="hidden profileView">
    <div class="profileHeader">
      <div class="profileAvatar" id="profileAvatar">?</div>
   <h2 id="profileName" style="display:inline-block;position:relative;">Usuario<span id="editNickBtn" title="Cambiar nickname" style="display:none;cursor:pointer;font-size:18px;margin-left:6px;">‚úèÔ∏è</span></h2>
<div id="nickEditBox" class="hidden" style="margin-top:10px;text-align:center;">
  <input id="newNickInput" type="text" placeholder="Nuevo nickname" style="padding:8px 10px;border-radius:8px;border:1px solid #ddd;max-width:250px;">
  <button id="saveNickBtn" class="btn" type="button">üíæ Guardar</button>
  <button id="cancelNickBtn" class="btn" type="button" style="background:#eee;color:#222;">Cancelar</button>
  <div id="nickMsg" class="status" style="margin-top:6px;"></div>
</div>
    </div>
      <div class="stats">
        <div>‚ù§Ô∏è <span id="likesCount">0</span> Likes</div>
        <div>üëÅÔ∏è <span id="visitsCount">0</span> Visitas</div>
      </div>
    <h3 style="text-align:center;margin-bottom:8px;">Juegos subidos</h3>
    <div class="gamesGrid" id="userGamesGrid"></div>
    <div style="text-align:center;margin-top:16px;">
      <button id="backHomeBtn" class="btn" style="width:auto;" type="button">üè† Volver al inicio</button>
    </div>
  </div>

  <!-- GAME PAGE -->
  <div id="gameView" class="hidden gamePage">
    <iframe id="gamePreview" class="previewLarge" sandbox="allow-scripts allow-same-origin"></iframe>
    <div class="gameHeader">
      <h2 id="gameTitle">Nombre del juego</h2>
      <p id="gameDesc" class="metaMuted"></p>
      <div class="metaMuted" id="statsLine">
        ‚ù§Ô∏è <span id="likeCount" class="countClickable">0</span>
        <span id="dislikeSection" class="hidden"> ¬∑ üëé <span id="dislikeCount" class="countClickable">0</span></span>
        ¬∑ üëÅÔ∏è <span id="visitCount">0</span>
        ¬∑ üìÖ Publicado: <span id="publishedOn">‚Äî</span>
      </div>
      <p class="creatorRow">Creador:
        <span class="creatorAvatar" id="gameCreatorAvatar">U</span>
        <span id="gameCreator" style="color:#ff8a00;font-weight:700;cursor:pointer;">Usuario</span>
      </p>
      <div class="gameActions">
        <button id="likeBtn" class="btn toggleBtn" type="button">Like</button>
        <button id="dislikeBtn" class="btn toggleBtn" type="button">Dislike</button>
        <button id="playBtn" class="btn" style="padding:14px 28px;font-weight:900" type="button">Jugar</button>
        <button id="editGameBtn" class="btn hidden" type="button">‚úèÔ∏è Editar juego</button>
        <button id="deleteGameBtn" class="btn btn--danger hidden" type="button">üóëÔ∏è Eliminar juego</button>
      </div>
      <div style="margin-top:16px"><button id="backHomeFromGame" class="btn" type="button">üè† Volver</button></div>
    </div>
  </div>

  <!-- UPLOAD / EDIT -->
  <div id="uploadView" class="hidden uploader">
    <h2 id="uploadTitle" style="text-align:center;margin-bottom:6px;">Subir nuevo juego</h2>
    <div class="row"><input id="gameNameIn" type="text" placeholder="Nombre del juego" style="flex:1"></div>
    <div class="row"><input id="gameDescIn" type="text" placeholder="Descripci√≥n corta" style="flex:1"></div>
    <div class="tabbar">
      <button id="tabEdit" class="active" type="button">Editor</button>
      <button id="tabPreview" type="button">Preview</button>
      <span class="counter" id="byteCounter">0 / 1,048,576 bytes</span>
    </div>
    <textarea id="codeEditor" class="editor" placeholder="Pega o escribe tu HTML + CSS + JS aqu√≠ (todo en uno)"></textarea>
    <iframe id="codePreview" class="previewEdit hidden" sandbox="allow-scripts allow-same-origin"></iframe>
    <div class="row" style="margin-top:12px;justify-content:center;">
      <button id="submitGameBtn" class="btn" type="button">Subir juego</button>
      <button id="saveEditBtn" class="btn hidden" type="button">üíæ Guardar cambios</button>
      <button id="cancelUploadBtn" class="btn" style="background:#eee;color:#222;" type="button">Cancelar</button>
    </div>
  </div>

</main>

<!-- FAB -->
<button id="fab" class="fab hidden" title="Subir juego" type="button">+</button>

<!-- FULLSCREEN PLAYER -->
<div id="playerFS" class="playerFS" style="display:none;">
  <iframe id="fsFrame" class="fsFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  <button id="fsClose" class="fsClose" type="button">Salir</button>
</div>

<!-- MODAL DE VOTANTES -->
<div id="votersModal" class="modalOverlay" style="display:none;">
  <div class="modalBox">
    <h3 id="votersTitle" style="margin-top:0;text-align:center;">Votantes</h3>
    <div id="votersList" class="votersList"></div>
    <div style="text-align:center;margin-top:12px;">
      <button id="closeVoters" class="btn" type="button">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ========= Config & Auth (REST) ========= */
const SUPA_URL="https://arypwvzmjedlhsrzrgxw.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeXB3dnptamVkbGhzcnpyZ3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzgwNDgsImV4cCI6MjA3NTc1NDA0OH0.oLuc_NKB2xh0-43clDOSP0ShISP9shjdrSJgd0jo0uY";

/* Nebula Glow (avatar y filtro) */
const NEBULA_EMAIL_LOWER = "pablomassofia@gmail.com";
const NEBULA_NICK_LOWER  = "pablodev";
const NEBULA_LOGO_URL    = "https://arypwvzmjedlhsrzrgxw.supabase.co/storage/v1/object/public/avatars/NebulaGlow.png";

const SESSION_KEY="na_session_v1";
let session=null;
function loadSession(){ try{session=JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch{session=null;} }
function saveSession(s){ session=s; localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function clearSession(){ session=null; localStorage.removeItem(SESSION_KEY); }

async function ensureFreshToken(){
  if(!session) return;
  const now = Math.floor(Date.now()/1000);
  if(session.expires_at && session.expires_at - now > 60) return;
  const res = await fetch(`${SUPA_URL}/auth/v1/token?grant_type=refresh_token`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` },
    body: JSON.stringify({ refresh_token: session.refresh_token })
  });
  const data = await res.json().catch(()=>null);
  if(!res.ok || !data?.access_token) throw new Error("No se pudo refrescar token");
  const expires_at = now + (data.expires_in||3600);
  saveSession({ access_token:data.access_token, refresh_token:data.refresh_token||session.refresh_token, expires_at, user: session.user });
}
async function rest(method, path, { query=null, body=null }={}){
  await ensureFreshToken();
  const qs = query ? "?"+new URLSearchParams(query).toString() : "";
  const res = await fetch(`${SUPA_URL}${path}${qs}`,{
    method,
    headers:{
      apikey: SUPA_KEY,
      Authorization: session? `Bearer ${session.access_token}` : `Bearer ${SUPA_KEY}`,
      "Content-Type":"application/json",
      "Prefer":"return=representation"
    },
    body: body? JSON.stringify(body): null
  });
  const text = await res.text();
  let json=null; try{ json = text? JSON.parse(text): null; }catch{ json=null; }
  if(!res.ok) throw new Error(json?.message || json?.error_description || json?.msg || `HTTP ${res.status}`);
  return json;
}
async function signUp(email,password,nickname){
  return rest("POST","/auth/v1/signup",{ body:{ email, password, data:{ nickname } } });
}
async function login(email,password){
  const now=Math.floor(Date.now()/1000);
  const res = await fetch(`${SUPA_URL}/auth/v1/token?grant_type=password`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` },
    body: JSON.stringify({ email, password })
  });
  const data = await res.json().catch(()=>null);
  if(!res.ok || !data?.access_token) throw new Error(data?.error_description || "No se pudo iniciar sesi√≥n");
  const ures = await fetch(`${SUPA_URL}/auth/v1/user`,{ headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${data.access_token}` }});
  const user = await ures.json().catch(()=>null);
  if(!ures.ok) throw new Error("No se pudo obtener el usuario");
  const expires_at = now + (data.expires_in||3600);
  saveSession({ access_token:data.access_token, refresh_token:data.refresh_token, expires_at, user });
}
async function logout(){
  if(session){
    try{
      await fetch(`${SUPA_URL}/auth/v1/logout`,{ method:"POST", headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${session.access_token}` } });
    }catch{}
  }
  clearSession();
}

/* ========= DOM ========= */
const $=id=>document.getElementById(id);
const topbar=$("topbar"), authView=$("authView"), appView=$("appView");
const homeView=$("homeView"), profileView=$("profileView"), gameView=$("gameView"), uploadView=$("uploadView");
const userMenu=$("userMenu"), userBtn=$("userBtn"), dropdown=$("dropdown");
const userAvatar=$("userAvatar"), userNameTop=$("userNameTop"), deleteBtn=$("deleteBtn");
const logoutBtn=$("logoutBtn"), viewProfileBtn=$("viewProfileBtn"), backHomeBtn=$("backHomeBtn");
const gamesGrid=$("gamesGrid"), userGamesGrid=$("userGamesGrid"), searchInput=$("searchInput");
const loadMoreWrap=$("loadMoreWrap"), loadMoreBtn=$("loadMoreBtn");
const fab=$("fab");
const gamePreview=$("gamePreview"), gameTitle=$("gameTitle"), gameDesc=$("gameDesc"), likeCount=$("likeCount"), visitCount=$("visitCount"), gameCreator=$("gameCreator"), publishedOn=$("publishedOn");
const gameCreatorAvatar=$("gameCreatorAvatar");
const likeBtn=$("likeBtn"), dislikeBtn=$("dislikeBtn"), playBtn=$("playBtn"), backHomeFromGame=$("backHomeFromGame"), deleteGameBtn=$("deleteGameBtn");
const editGameBtn=$("editGameBtn");
const dislikeSection=$("dislikeSection"), dislikeCount=$("dislikeCount");
const profileAvatar=$("profileAvatar"), profileName=$("profileName"), likesCount=$("likesCount"), visitsCount=$("visitsCount");
const gameNameIn=$("gameNameIn"), gameDescIn=$("gameDescIn"), codeEditor=$("codeEditor"), codePreview=$("codePreview");
const tabEdit=$("tabEdit"), tabPreview=$("tabPreview"), byteCounter=$("byteCounter"), uploadTitle=$("uploadTitle");
const loginForm=$("loginForm"), signupForm=$("signupForm"), showSignup=$("showSignup"), showLogin=$("showLogin");
const loginEmail=$("loginEmail"), loginPass=$("loginPass"), loginBtn=$("loginBtn"), loginError=$("loginError"), loginStatus=$("loginStatus");
const signupBtn=$("signupBtn"), signupError=$("signupError"), signupStatus=$("signupStatus"), nick=$("nick"), signupEmail=$("signupEmail"), signupPass=$("signupPass");
const cancelUploadBtn=$("cancelUploadBtn"), submitGameBtn=$("submitGameBtn"), saveEditBtn=$("saveEditBtn");
const playerFS=$("playerFS"), fsFrame=$("fsFrame"), fsClose=$("fsClose");
const fPopular=$("fPopular"), fNew=$("fNew"), fClassic=$("fClassic"), fNebula=$("fNebula");

/* Modal votantes */
const votersModal=$("votersModal"), votersList=$("votersList"), votersTitle=$("votersTitle"), closeVoters=$("closeVoters");
closeVoters.onclick=()=>votersModal.style.display="none";

/* ========= Estado ========= */
let currentUser=null;
let allGames=[];
let currentGame=null;
let viewingUserId=null;
let currentVote=null;

let activeFilter=null; // null | 'popular' | 'new' | 'classic' | 'nebula'
const PAGE_SIZE=50;
let pageIndex=0;
let currentList=[];
let nebulaIds = new Set(); // perfiles cuyo email == NEBULA_EMAIL_LOWER

/* ========= Utils ========= */
function closeDropdown(){ dropdown.style.display="none"; }
function bytesOf(str){ return new Blob([str||""]).size; }
function srcdocSafe(html){ return html || "<!doctype html><html><body>Empty</body></html>"; }
function nic(s){ return (s||"").trim(); }
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function isAdmin(){ return (currentUser?.email||"").toLowerCase()===NEBULA_EMAIL_LOWER; } /* t√∫ eres admin */
function formatDate(d){ try{ return new Date(d).toLocaleDateString('es-ES'); }catch{ return '‚Äî'; } }

/* Avatares: Nebula o inicial */
function avatarHTMLByEmail(email, initial, sizePx){
  const isNeb = (email||"").toLowerCase()===NEBULA_EMAIL_LOWER;
  if(isNeb){
    return `<img src="${NEBULA_LOGO_URL}" style="width:${sizePx}px;height:${sizePx}px;border-radius:50%;object-fit:cover;">`;
  }
  return `<span style="display:inline-flex;align-items:center;justify-content:center;width:${sizePx}px;height:${sizePx}px;border-radius:50%;background:#f5f5f5;color:#111;font-weight:900;">${(initial||"?").toUpperCase()}</span>`;
}
function setCircleAvatarElement(el, email, initial){
  const isNeb = (email||"").toLowerCase()===NEBULA_EMAIL_LOWER;
  if(isNeb){
    el.innerHTML = `<img src="${NEBULA_LOGO_URL}" alt="Nebula Glow">`;
  }else{
    el.textContent = (initial||"?").toUpperCase();
  }
}

/* ========= Auth UI ========= */
showSignup.onclick=()=>{loginForm.classList.add("hidden");signupForm.classList.remove("hidden");};
showLogin.onclick=()=>{signupForm.classList.add("hidden");loginForm.classList.remove("hidden");};

signupBtn.onclick=async()=>{
  const nickname=nic(nick.value), email=nic(signupEmail.value), pass=signupPass.value;
  signupError.textContent=""; signupError.style.color="#b91c1c";
  signupStatus.textContent=""; signupStatus.classList.remove("hidden");
  if(!nickname||!email||!pass){ signupError.textContent="Completa todos los campos."; signupStatus.classList.add("hidden"); return;}
  if(pass.length<6){ signupError.textContent="La contrase√±a debe tener al menos 6 caracteres."; signupStatus.classList.add("hidden"); return;}
  signupStatus.innerHTML='<span class="loader"></span>Creando cuenta...';
  try{
    const data = await signUp(email,pass,nickname);
    signupStatus.classList.add("hidden");
    if(data?.user?.identities?.length===0){ signupError.textContent="Ese correo ya est√° registrado."; return; }
    signupError.style.color="#2563eb";
    signupError.textContent="üìß Revisa tu email para verificar la cuenta (puede ir a SPAM).";
  }catch(e){
    signupStatus.classList.add("hidden");
    signupError.textContent="Error: "+(e.message||e);
  }
};

loginBtn.onclick=async()=>{
  const email=nic(loginEmail.value), pass=loginPass.value;
  loginError.textContent=""; loginStatus.textContent=""; loginStatus.classList.remove("hidden");
  if(!email||!pass){ loginError.textContent="Rellena ambos campos."; loginStatus.classList.add("hidden"); return;}
  loginBtn.disabled=true;
  loginStatus.innerHTML='<span class="loader"></span>Verificando credenciales...';
  try{
    await login(email,pass);
    loginStatus.textContent="‚úÖ Sesi√≥n iniciada. Cargando‚Ä¶";
    await afterLoginBoot();
  }catch(e){
    const msg=(e.message||"").toLowerCase();
    if(msg.includes("invalid login credentials")) loginError.textContent="‚ùå Credenciales incorrectas.";
    else if(msg.includes("email") && msg.includes("confirm")) loginError.textContent="‚úâÔ∏è Tu email no est√° verificado.";
    else loginError.textContent="‚ö†Ô∏è "+(e.message||e);
    await diagnose(loginStatus);
  }finally{ loginBtn.disabled=false; }
};

async function afterLoginBoot(){
  loadSession();
  if(!session || !session.user){ loginError.textContent="‚ö†Ô∏è Sesi√≥n no disponible tras login."; return; }
  currentUser = session.user;
  setTopbarUser(currentUser);
  showApp();
  try{ await loadGames(); }catch(e){ gamesGrid.innerHTML="<div class='metaMuted'>No se pudieron cargar los juegos.</div>"; }
  loginStatus.classList.add("hidden");
}

/* ========= Topbar & vistas ========= */
function setTopbarUser(u){
  const nick=u?.user_metadata?.nickname || u?.email || "Usuario";
  const email=(u?.email||"").toLowerCase();
  userNameTop.textContent=nick;
  // Avatar topbar: Nebula si es tu correo
  if(email===NEBULA_EMAIL_LOWER){
    userAvatar.innerHTML = `<img src="${NEBULA_LOGO_URL}" alt="Nebula Glow">`;
  }else{
    userAvatar.textContent=(nick[0]||"?").toUpperCase();
  }
  deleteBtn.style.display=(nick.toLowerCase()===NEBULA_NICK_LOWER)?"block":"none"; /* legado */
}
function showAuth(){authView.classList.remove("hidden");appView.classList.add("hidden");topbar.classList.add("hidden");}
function showApp(){authView.classList.add("hidden");appView.classList.remove("hidden");topbar.classList.remove("hidden"); setView("home");}
function setView(v){
  // Oculta todas las vistas
  homeView.classList.add("hidden");
  profileView.classList.add("hidden");
  gameView.classList.add("hidden");
  uploadView.classList.add("hidden");

  // Muestra solo la seleccionada
  if(v === "home") homeView.classList.remove("hidden");
  if(v === "profile") profileView.classList.remove("hidden");
  if(v === "game") gameView.classList.remove("hidden");
  if(v === "upload") uploadView.classList.remove("hidden");

  // Limpia posibles iframes duplicados
  gamePreview.srcdoc = "";
  fsFrame.srcdoc = "";

  updateFab();
}

viewProfileBtn.onclick=()=>{ if(currentUser) openProfile(currentUser.id); closeDropdown(); };
logoutBtn.onclick=async()=>{ await logout(); currentUser=null; showAuth(); closeDropdown(); };
userBtn.onclick=()=>{ dropdown.style.display=(dropdown.style.display==="flex")?"none":"flex"; dropdown.style.flexDirection="column"; };
window.addEventListener("click",(e)=>{ if(!userMenu.contains(e.target)) closeDropdown(); });

deleteBtn.onclick=async()=>{
  if(!currentUser) return;
  if(!confirm("¬øEliminar tu cuenta y juegos?")) return;
  try{
    await rest("DELETE","/rest/v1/games",{ query:{ creator_id:`eq.${currentUser.id}` } });
    await rest("DELETE","/rest/v1/profiles",{ query:{ id:`eq.${currentUser.id}` } });
    await logout();
    alert("Cuenta eliminada (datos de juegos y perfil).");
    showAuth();
  }catch(e){ alert("No se pudo eliminar todo. RLS/Pol√≠ticas: "+(e.message||e)); }
  closeDropdown();
};

/* ========= Diagn√≥stico simple ========= */
async function diagnose(label){
  try{
    const r1 = await fetch(`${SUPA_URL}/rest/v1/?select=now()`, { headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` }});
    const r2 = await fetch(`${SUPA_URL}/auth/v1/health`, { headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` }});
    label.textContent = `üîé REST: ${r1.status} ¬∑ AUTH: ${r2.status}`;
  }catch{ label.textContent="üîé No hay conexi√≥n (CORS/red)"; }
}

/* ========= Games ========= */
async function loadGames(){
  const params = { select:"id,creator_id,title,description,code,likes,dislikes,visits,created_at", order:"created_at.desc", limit:500 };
  const data = await rest("GET","/rest/v1/games",{ query:params });
  allGames = data || [];

  // Mapa de nombres + emails para avatares
  const ids=[...new Set(allGames.map(g=>g.creator_id).filter(Boolean))];
  let nameMap={}, emailMap={};
  if(ids.length){
    const list = `(${ids.map(x=>`"${x}"`).join(",")})`;
    let profs=null;
    try{
      profs = await rest("GET","/rest/v1/profiles",{ query:{ select:"id,nickname,email", id:`in.${list}` } });
    }catch{
      profs = await rest("GET","/rest/v1/profiles",{ query:{ select:"id,nickname", id:`in.${list}` } });
    }
    (profs||[]).forEach(p=>{
      nameMap[p.id]=p.nickname || "Usuario";
      if('email' in p) emailMap[p.id]=(p.email||"");
    });
  }
  allGames.forEach(g=>{
    g.creator_name = nameMap[g.creator_id] || "Usuario";
    g.creator_email = emailMap[g.creator_id] || "";
  });

  // Resolver IDs de Nebula (por email directo o nickname fallback)
  await determineNebulaIds();

  applyFiltersAndRender(true);
}

async function determineNebulaIds(){
  nebulaIds = new Set();
  try{
    const rows = await rest("GET","/rest/v1/profiles",{ query:{ select:"id", email:`eq.${NEBULA_EMAIL_LOWER}` } });
    (rows||[]).forEach(r=>nebulaIds.add(r.id));
  }catch{
    try{
      const rows2 = await rest("GET","/rest/v1/profiles",{ query:{ select:"id", nickname:`eq.${NEBULA_NICK_LOWER}` } });
      (rows2||[]).forEach(r=>nebulaIds.add(r.id));
    }catch{}
  }
}

/* --- Filtros & orden --- */
function computeSortedList(){
  const q=searchInput.value.trim().toLowerCase();
  let list = q? allGames.filter(g=> ((g.title||"").toLowerCase().includes(q))) : [...allGames];

  if(activeFilter==="popular"){
    list.forEach(g=> g.__score = (g.likes||0) + 0.25*(g.visits||0));
    list.sort((a,b)=> (b.__score - a.__score) || ((b.likes||0)-(a.likes||0)) || ((b.visits||0)-(a.visits||0)) || (new Date(b.created_at)-new Date(a.created_at)) );
  }else if(activeFilter==="new"){
    list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  }else if(activeFilter==="classic"){
    list.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
  }else if(activeFilter==="nebula"){
    list = list.filter(g=> nebulaIds.has(g.creator_id) || (g.creator_email||"").toLowerCase()===NEBULA_EMAIL_LOWER);
    list.forEach(g=> g.__score = (g.likes||0) + 0.25*(g.visits||0));
    list.sort((a,b)=> (b.__score - a.__score) || ((b.likes||0)-(a.likes||0)) || ((b.visits||0)-(a.visits||0)) || (new Date(b.created_at)-new Date(a.created_at)) );
  }
  return list;
}

function miniAvatarMarkupForGame(g){
  const initial = (g.creator_name||"U").charAt(0).toUpperCase();
  const email = (g.creator_email||"").toLowerCase();
  const isNeb = email===NEBULA_EMAIL_LOWER || nebulaIds.has(g.creator_id);
  if(isNeb){
    return `<span class="miniAvatar"><img src="${NEBULA_LOGO_URL}" alt="Nebula Glow"></span>`;
  }
  return `<span class="miniAvatar">${initial}</span>`;
}

function applyFiltersAndRender(reset){
  if(reset){ pageIndex=0; currentList = computeSortedList(); gamesGrid.innerHTML=""; }
  const remaining = currentList.length - pageIndex;
  const take = Math.min(PAGE_SIZE, remaining);
  const slice = currentList.slice(pageIndex, pageIndex+take);
  slice.forEach((g)=>{
    const card=document.createElement("div"); card.className="gameCard";
    card.innerHTML=`
      <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
      <iframe class="cardPreview" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
      <div class="metaMuted">${miniAvatarMarkupForGame(g)}Por ${escapeHtml(g.creator_name)} ¬∑ ‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>`;
    card.querySelector("iframe").srcdoc = srcdocSafe(mutePreview(g.code||""));
    card.onclick=()=>openGame(g.id);
    gamesGrid.appendChild(card);
  });
  pageIndex += take;
  loadMoreWrap.style.display = (pageIndex < currentList.length) ? "flex" : "none";
}

searchInput.addEventListener("input", ()=>applyFiltersAndRender(true));
loadMoreBtn.addEventListener("click", ()=>applyFiltersAndRender(false));

// Toggle exclusivo de filtros
[fPopular,fNew,fClassic,fNebula].forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const f = btn.dataset.filter;
    if(activeFilter===f){
      activeFilter=null;
      [fPopular,fNew,fClassic,fNebula].forEach(b=>b.classList.remove("active"));
    }else{
      activeFilter=f;
      [fPopular,fNew,fClassic,fNebula].forEach(b=>b.classList.toggle("active", b.dataset.filter===f));
    }
    applyFiltersAndRender(true);
  });
});

/* ========= Game Page + Votos ========= */
async function openGame(id){
  const g=allGames.find(x=>x.id===id); if(!g) return;
  currentGame = g; currentVote=null;
  setView("game");
  gamePreview.srcdoc = srcdocSafe(mutePreview(g.code||""));
  gameTitle.textContent=g.title||"Sin t√≠tulo";
  gameDesc.textContent=g.description||"";
  likeCount.textContent=g.likes||0; visitCount.textContent=g.visits||0;
  publishedOn.textContent = formatDate(g.created_at);
  gameCreator.textContent=g.creator_name||"Usuario";
  gameCreator.onclick=()=>openProfile(g.creator_id);

  // Avatar del creador (Nebula si aplica)
  const isNebCreator = ((g.creator_email||"").toLowerCase()===NEBULA_EMAIL_LOWER) || nebulaIds.has(g.creator_id);
  if(isNebCreator){
    gameCreatorAvatar.innerHTML = `<img src="${NEBULA_LOGO_URL}" alt="Nebula Glow">`;
  }else{
    gameCreatorAvatar.textContent = (g.creator_name||"U").charAt(0).toUpperCase();
  }

  const canEditDelete = currentUser && (currentUser.id===g.creator_id || isAdmin());
  deleteGameBtn.classList.toggle("hidden", !canEditDelete);
  editGameBtn.classList.toggle("hidden", !canEditDelete);

  // Mostrar secci√≥n de dislikes solo al creador/admin
  const isCreator = currentUser && (currentUser.id===g.creator_id || isAdmin());
  dislikeSection.classList.toggle("hidden", !isCreator);
  $("dislikeCount").textContent = g.dislikes||0;

  if(currentUser){
    try{
      const rows = await rest("GET","/rest/v1/votes",{ query:{ select:"id,type", user_id:`eq.${currentUser.id}`, game_id:`eq.${g.id}` }});
      currentVote = rows?.[0] || null;
      syncVoteButtons();
    }catch(_){ /* ignore */ }
  }else{
    currentVote=null; syncVoteButtons();
  }
}
function syncVoteButtons(){
  likeBtn.classList.toggle("active", currentVote?.type==="like");
  dislikeBtn.classList.toggle("active", currentVote?.type==="dislike");
}
likeBtn.onclick = ()=>handleVote("like");
dislikeBtn.onclick = ()=>handleVote("dislike");

/* Ver lista de votantes (solo si eres el creador/admin, silencioso si no) */
likeCount.onclick = ()=> showVoters("like");
dislikeCount.onclick = ()=> showVoters("dislike");

async function showVoters(type){
  if(!currentUser || !currentGame) return;
  const canView = (currentUser.id===currentGame.creator_id) || isAdmin();
  if(!canView) return; // nada si no es creador

  votersTitle.textContent = type==="like" ? "‚ù§Ô∏è Usuarios que dieron Like" : "üëé Usuarios que dieron Dislike";
  votersList.innerHTML = '<div class="metaMuted">Cargando...</div>';
  votersModal.style.display = "flex";

  try{
    const rows = await rest("GET","/rest/v1/votes",{
      query:{ select:"user_id,type", game_id:`eq.${currentGame.id}`, type:`eq.${type}` }
    });
    if(!rows || !rows.length){ votersList.innerHTML = '<div class="metaMuted">Nadie ha votado a√∫n.</div>'; return; }

    const ids = [...new Set(rows.map(r=>r.user_id))];
    const list = `(${ids.map(x=>`"${x}"`).join(",")})`;

    let profs=null;
    let gotEmail=true;
    try{
      profs = await rest("GET","/rest/v1/profiles",{ query:{ select:"id,nickname,email", id:`in.${list}` } });
    }catch{
      gotEmail=false;
      profs = await rest("GET","/rest/v1/profiles",{ query:{ select:"id,nickname", id:`in.${list}` } });
    }
    const nameMap={}, emailMap={};
    (profs||[]).forEach(p=>{ nameMap[p.id]=p.nickname||"Usuario"; if('email' in p) emailMap[p.id]=p.email||""; });

    votersList.innerHTML="";
    rows.forEach(v=>{
      const name = nameMap[v.user_id] || "Usuario";
      const email = (emailMap[v.user_id]||"").toLowerCase();
      const nebById = nebulaIds.has(v.user_id);
      const showNebula = (email===NEBULA_EMAIL_LOWER) || (gotEmail?false:nebById);

      const row=document.createElement("div");
      row.className="voterItem";
      row.innerHTML=`
        <span class="miniAvatar">${showNebula?`<img src="${NEBULA_LOGO_URL}" alt="Nebula Glow">`:(name.charAt(0)||"U").toUpperCase()}</span>
        <span style="font-weight:700">${escapeHtml(name)}</span>
      `;
      row.onclick=()=>{
        votersModal.style.display="none";
        openProfile(v.user_id);
      };
      votersList.appendChild(row);
    });
  }catch(e){
    votersList.innerHTML = `<div class="metaMuted">No se pudo cargar la lista.</div>`;
  }
}

async function handleVote(type){
  if(!currentUser || !currentGame) { alert("Inicia sesi√≥n para votar."); return; }
  const g=currentGame;
  const prev = currentVote?.type || null;

  try{
    if(prev===type){
      if(currentVote?.id){
        await rest("DELETE","/rest/v1/votes",{ query:{ id:`eq.${currentVote.id}` }});
      }
      currentVote=null;
      if(type==="like"){
        g.likes=Math.max(0,(g.likes||0)-1); likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes } });
      }else{
        g.dislikes=Math.max(0,(g.dislikes||0)-1);
        $("dislikeCount").textContent=g.dislikes||0;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ dislikes:g.dislikes } });
      }
    }else if(prev===null){
      const ins = await rest("POST","/rest/v1/votes",{ body:{ user_id:currentUser.id, game_id:g.id, type }});
      currentVote = ins?.[0] || null;
      if(type==="like"){
        g.likes=(g.likes||0)+1; likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes } });
      }else{
        g.dislikes=(g.dislikes||0)+1; $("dislikeCount").textContent=g.dislikes||0;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ dislikes:g.dislikes } });
      }
    }else{
      if(currentVote?.id){
        const upd = await rest("PATCH","/rest/v1/votes",{ query:{ id:`eq.${currentVote.id}` }, body:{ type }});
        currentVote = upd?.[0] || null;
      }else{
        const ins2 = await rest("POST","/rest/v1/votes",{ body:{ user_id:currentUser.id, game_id:g.id, type }});
        currentVote = ins2?.[0] || null;
      }
      if(type==="like"){
        g.likes=(g.likes||0)+1; likeCount.textContent=g.likes;
        g.dislikes=Math.max(0,(g.dislikes||0)-1); $("dislikeCount").textContent=g.dislikes||0;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes, dislikes:g.dislikes } });
      }else{
        g.dislikes=(g.dislikes||0)+1; $("dislikeCount").textContent=g.dislikes||0;
        g.likes=Math.max(0,(g.likes||0)-1); likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes, dislikes:g.dislikes } });
      }
    }
  }catch(e){
    console.warn("vote error", e);
    alert("No se pudo registrar el voto (RLS/pol√≠ticas).");
  }finally{
    syncVoteButtons();
  }
}

/* ========= JUGAR en pantalla completa ========= */
playBtn.onclick = async () => {
  if(!currentGame) return;
  document.body.style.overflow="hidden";
  playerFS.style.display="block";
  fsFrame.srcdoc = srcdocSafe(currentGame.code);

  try{
    const updated = await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${currentGame.id}` }, body:{ visits:(currentGame.visits||0)+1 } });
    if(updated?.[0]){ currentGame.visits=updated[0].visits; visitCount.textContent=currentGame.visits; }
  }catch(_){}
};
fsClose.onclick = () => {
  fsFrame.srcdoc="";
  playerFS.style.display="none";
  document.body.style.overflow="";
};

/* ========= Eliminar juego ========= */
deleteGameBtn.onclick = async ()=>{
  if(!currentUser || !currentGame) return;
  const g=currentGame;
  const canDelete = (currentUser.id===g.creator_id) || isAdmin();
  if(!canDelete){ alert("No tienes permisos para borrar este juego."); return; }
  if(!confirm(`¬øEliminar "${g.title||'este juego'}"?`)) return;
  try{
    await rest("DELETE","/rest/v1/games",{ query:{ id:`eq.${g.id}` } });
    allGames = allGames.filter(x=>x.id!==g.id);
    setView("home"); applyFiltersAndRender(true);
  }catch(e){
    alert("No se pudo eliminar (RLS). Si eres admin y falla, ajusta pol√≠ticas de DELETE en public.games");
  }
};

/* ========= Perfil ========= */
async function openProfile(userId){
  viewingUserId=userId; setView("profile");
  let nickTxt="Usuario", emailTxt="";
  try{
    const arr = await rest("GET","/rest/v1/profiles",{ query:{ select:"nickname,email", id:`eq.${userId}` } });
    if(arr?.[0]){
      nickTxt=arr[0].nickname||"Usuario";
      emailTxt=(arr[0].email||"");
    }
    toggleNickEditor(userId);
  }catch{
    // fallback si no hay columna email
    const arr2 = await rest("GET","/rest/v1/profiles",{ query:{ select:"nickname", id:`eq.${userId}` } });
    if(arr2?.[0]) nickTxt=arr2[0].nickname||"Usuario";
  }

  toggleNickEditor(userId);
  profileName.textContent=nickTxt;
  const isNeb = (emailTxt||"").toLowerCase()===NEBULA_EMAIL_LOWER || nebulaIds.has(userId);
  if(isNeb){
    profileAvatar.innerHTML = `<img src="${NEBULA_LOGO_URL}" alt="Nebula Glow">`;
  }else{
    profileAvatar.textContent=(nickTxt[0]||"?").toUpperCase();
  }

  const mine = allGames.filter(g=>g.creator_id===userId);
  likesCount.textContent = mine.reduce((a,b)=>a+(b.likes||0),0);
  visitsCount.textContent = mine.reduce((a,b)=>a+(b.visits||0),0);

  userGamesGrid.innerHTML="";
  if(!mine.length){
    const txt=(currentUser && currentUser.id===userId)?"No has subido ning√∫n juego.":"No ha subido ning√∫n juego.";
    const noDiv=document.createElement("div"); noDiv.className="metaMuted"; noDiv.style.textAlign="center"; noDiv.style.padding="12px"; noDiv.textContent=txt;
    userGamesGrid.appendChild(noDiv);
  }else{
    mine.forEach((g)=>{
      const card=document.createElement("div"); card.className="gameCard";
      card.innerHTML=`
        <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
        <iframe class="cardPreview" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
        <div class="metaMuted">${miniAvatarMarkupForGame(g)}‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>`;
      card.querySelector("iframe").srcdoc = srcdocSafe(mutePreview(g.code||""));
      card.onclick=()=>openGame(g.id);
      userGamesGrid.appendChild(card);
    });
  }
}
backHomeBtn.onclick=()=>setView("home");
backHomeFromGame.onclick=()=>setView("home");

/* ========= Upload / Edit ========= */
const MAX_BYTES=1048576;
fab.onclick=()=>openUpload(false,null);
function updateFab(){ fab.classList.toggle("hidden", !currentUser || homeView.classList.contains("hidden")); }

function openUpload(isEditing=false, gameToEdit=null){
  if(!currentUser){ alert("Inicia sesi√≥n para subir o editar juegos."); return; }
  setView("upload");

  if(isEditing && gameToEdit){
    uploadTitle.textContent="Editar juego";
    submitGameBtn.classList.add("hidden");
    saveEditBtn.classList.remove("hidden");
    gameNameIn.value=gameToEdit.title||"";
    gameDescIn.value=gameToEdit.description||"";
    codeEditor.value=gameToEdit.code||"";
    codePreview.srcdoc=srcdocSafe(gameToEdit.code);
    codePreview.classList.add("hidden");
    tabEdit.classList.add("active");
    tabPreview.classList.remove("active");
    updateByteCounter();

    saveEditBtn.onclick = async ()=>{
      const title=nic(gameNameIn.value), description=nic(gameDescIn.value), code=codeEditor.value;
      if(!title||!code){ alert("Pon al menos nombre y c√≥digo."); return; }
      if(bytesOf(code)>MAX_BYTES){ alert("Tu juego supera 1 MB."); return; }
      try{
        const updated = await rest("PATCH","/rest/v1/games",{ 
          query:{ id:`eq.${gameToEdit.id}` },
          body:{ title, description, code }
        });
        if(updated?.[0]){
          const newGame = updated[0];
          const idx = allGames.findIndex(x=>x.id===gameToEdit.id);
          if(idx>=0){
            allGames[idx] = { ...allGames[idx], ...newGame };
          }
          alert("‚úÖ Juego actualizado correctamente.");
          openGame(gameToEdit.id);
        }
      }catch(e){
        alert("No se pudo actualizar el juego: "+(e.message||e));
      }
    };
  } else {
    uploadTitle.textContent="Subir nuevo juego";
    submitGameBtn.classList.remove("hidden");
    saveEditBtn.classList.add("hidden");
    gameNameIn.value=""; gameDescIn.value=""; codeEditor.value="";
    codePreview.srcdoc=""; updateByteCounter(); tabTo("edit");
  }
}

cancelUploadBtn.onclick=()=>setView("home");
tabEdit.onclick=()=>tabTo("edit");
tabPreview.onclick=()=>tabTo("preview");
function tabTo(w){
  if(w==="edit"){
    tabEdit.classList.add("active");tabPreview.classList.remove("active");
    codeEditor.classList.remove("hidden");codePreview.classList.add("hidden");
  }else{
    tabPreview.classList.add("active");tabEdit.classList.remove("active");
    codeEditor.classList.add("hidden");codePreview.classList.remove("hidden");
    codePreview.srcdoc=srcdocSafe(codeEditor.value);
  }
}
function updateByteCounter(){ const n=bytesOf(codeEditor.value); byteCounter.textContent=`${n.toLocaleString()} / ${MAX_BYTES.toLocaleString()} bytes`; }
codeEditor.addEventListener("input",updateByteCounter);

submitGameBtn.onclick=async()=>{
  if(!currentUser){ alert("Inicia sesi√≥n."); return; }
  const title=nic(gameNameIn.value), description=nic(gameDescIn.value), code=codeEditor.value;
  if(!title||!code){ alert("Pon al menos nombre y c√≥digo."); return; }
  if(bytesOf(code)>MAX_BYTES){ alert("Tu juego supera 1 MB."); return; }
  try{
    const inserted = await rest("POST","/rest/v1/games",{ body:{ creator_id:currentUser.id, title, description, code, likes:0, dislikes:0, visits:0 } });
    const game = inserted?.[0];
    if(game){
      game.creator_name = currentUser.user_metadata?.nickname||currentUser.email;
      game.creator_email = currentUser.email || "";
      allGames.unshift(game);
      applyFiltersAndRender(true);
      openGame(game.id);
    }
  }catch(e){ alert("No se pudo subir el juego. Revisa RLS: "+(e.message||e)); }
};

/* ========= Bot√≥n Editar en Game Page ========= */
editGameBtn.onclick = ()=> {
  if(!currentGame) return;
  const g=currentGame;
  openUpload(true, g);
};

  // === Cambio de nickname ===
const editNickBtn = $("editNickBtn");
const nickEditBox = $("nickEditBox");
const newNickInput = $("newNickInput");
const saveNickBtn = $("saveNickBtn");
const cancelNickBtn = $("cancelNickBtn");
const nickMsg = $("nickMsg");

function toggleNickEditor(userId){
  if(currentUser && currentUser.id === userId){
    editNickBtn.style.display="inline-block";
  }else{
    editNickBtn.style.display="none";
    nickEditBox.classList.add("hidden");
  }
}

editNickBtn.onclick = ()=>{
  editNickBtn.style.display="none";
  nickEditBox.classList.remove("hidden");
  newNickInput.value = profileName.textContent || "";
  nickMsg.textContent="";
};

cancelNickBtn.onclick = ()=>{
  editNickBtn.style.display="inline-block";
  nickEditBox.classList.add("hidden");
  nickMsg.textContent="";
};

saveNickBtn.onclick = async ()=>{
  const newNick = (newNickInput.value||"").trim();
  if(!newNick){ nickMsg.textContent="Pon un nickname v√°lido."; return; }
  nickMsg.innerHTML='<span class="loader"></span> Guardando...';
  try{
    // Actualiza tabla perfiles
    await rest("PATCH","/rest/v1/profiles",{ query:{ id:`eq.${currentUser.id}` }, body:{ nickname:newNick }});
    // Actualiza auth user_metadata.nickname
    await fetch(`${SUPA_URL}/auth/v1/user`,{
      method:"PATCH",
      headers:{
        apikey:SUPA_KEY,
        "Content-Type":"application/json",
        Authorization:`Bearer ${session.access_token}`
      },
      body: JSON.stringify({ data:{ nickname:newNick } })
    });
    // Refresca UI
    profileName.textContent=newNick;
    userNameTop.textContent=newNick;
        // Actualiza tambi√©n la sesi√≥n local
    if(session?.user?.user_metadata){
      session.user.user_metadata.nickname = newNick;
      saveSession(session);
    }
    nickMsg.textContent="‚úÖ Nickname cambiado";
    setTimeout(()=>{
      editNickBtn.style.display="inline-block";
      nickEditBox.classList.add("hidden");
      nickMsg.textContent="";
    },800);
  }catch(e){
    nickMsg.textContent="‚ùå Error: "+(e.message||e);
  }
};

  function mutePreview(html){
  const patch = String.raw`
<script>
(function(){
  // Evita reproducir sonidos por cualquier v√≠a conocida
  function hush(){
    document.querySelectorAll('audio,video').forEach(el=>{
      try{
        el.muted = true;
        el.volume = 0;
        el.pause();
      }catch(_){}
    });
  }
  hush();
  new MutationObserver(hush).observe(document.body,{childList:true,subtree:true});
  setInterval(hush,800);

  // Bloquea nuevos contextos de audio
  const BlockedCtx = function(){
    const e = new Error('Audio bloqueado en previews');
    console.warn(e);
    throw e;
  };
  window.AudioContext = BlockedCtx;
  window.webkitAudioContext = BlockedCtx;

  // Silencia tambi√©n new Audio()
  const _Audio = window.Audio;
  window.Audio = function(){
    const a = new _Audio(...arguments);
    try{ a.muted = true; a.volume = 0; }catch(_){}
    setTimeout(()=>{ try{ a.pause(); }catch(_){}} ,10);
    return a;
  };

  // Captura cualquier intento de sonido desde librer√≠as (p5.js, Tone.js, etc.)
  Object.defineProperty(window, 'Tone', {
    set: ()=>{ console.warn('Tone.js bloqueado en previews'); },
    get: ()=>({ start:()=>{}, context:{ resume:()=>{} } })
  });

  // Silencia cualquier oscilador / WebAudio node
  window.OscillatorNode = function(){
    console.warn('OscillatorNode bloqueado en previews');
    return { start:()=>{}, stop:()=>{} };
  };
})();
<\/script>`;
  return html.replace("</body>", patch + "</body>");
}

/* ========= Init ========= */
(async function init(){
  loadSession();
  if(session){
    try{
      await ensureFreshToken();
      currentUser = session.user;
      setTopbarUser(currentUser);
      showApp();
      await loadGames();
    }catch{
      clearSession(); showAuth();
    }
  }else{
    showAuth();
  }
  const obs=new MutationObserver(updateFab); obs.observe(homeView,{attributes:true,attributeFilter:["class"]});
  ["viewProfileBtn","logoutBtn","deleteBtn"].forEach(id=>{ const el=$(id); if(el) el.addEventListener("click",()=>closeDropdown()); });
})();
</script>
</body>
</html>
