<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nebula Arcade</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.2/dist/umd/supabase.min.js"></script>
<style>
:root{--grad1:#ff8a00;--grad2:#ffd200;--text:#1b1f24;--border:#e5e7eb;--muted:#6b7280;--bg:#fff;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui;background:var(--bg);color:var(--text);}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:20;}
.logo{font-family:"Fredoka One";font-size:22px;background:linear-gradient(90deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.userMenu{position:relative;}
.userBtn{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;font-weight:700;cursor:pointer;transition:.2s;}
.userBtn:hover{filter:brightness(1.05);}
.avatar{width:28px;height:28px;border-radius:50%;background:#fff;color:#2a2000;display:flex;align-items:center;justify-content:center;font-family:"Fredoka One";}
.dropdown{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.1);display:none;flex-direction:column;min-width:180px;overflow:hidden;z-index:30;}
.dropdown button{background:none;border:0;text-align:left;padding:10px 16px;cursor:pointer;font-weight:600;color:var(--text);transition:.15s;width:100%;}
.dropdown button:hover{background:#f9f9f9;}
main{max-width:1000px;margin:24px auto 90px;padding:0 18px;}
.searchBox{margin-bottom:18px;display:flex;gap:10px;}
.searchBox input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:15px;}
.searchBox input:focus{border-color:#ffd24d;outline:none;box-shadow:0 0 0 4px #ffe08d60;}
.gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
.gameCard{border:1px solid var(--border);border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:12px;transition:.2s;cursor:pointer;display:flex;flex-direction:column;gap:8px;}
.gameCard:hover{transform:translateY(-3px);}
.cardTitle{font-weight:800}
.cardPreview{width:100%;height:140px;border:0;border-radius:10px;background:#f3f3f3;}
.metaMuted{color:var(--muted);font-size:13px}
.hidden{display:none;}
.wrapAuth{max-width:420px;margin:10vh auto;padding:24px;border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 26px rgba(0,0,0,.06);background:#fff;}
input{width:100%;padding:12px;margin:6px 0;border:1px solid var(--border);border-radius:12px;font-size:15px}
input:focus{box-shadow:0 0 0 4px #ffe08d60;border-color:#ffd24d;outline:none}
.btn{border:0;border-radius:12px;padding:12px 20px;font-weight:800;cursor:pointer;color:#2a2000;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:.15s}
.btn:hover{background:linear-gradient(90deg,#ffa12b,#ffe04d);transform:translateY(-1px)}
.error{color:#b91c1c;font-size:14px;margin-top:6px;text-align:center}
.status{color:#2563eb;font-size:14px;margin-top:6px;text-align:center;white-space:pre-line}
.loader{display:inline-block;width:16px;height:16px;border:3px solid #ffd24d;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.link{color:var(--muted);font-size:14px;text-decoration:underline;cursor:pointer;text-align:center;display:block;margin-top:12px}
.profileView{max-width:700px;margin:0 auto;}
.profileHeader{text-align:center;margin-bottom:16px}
.profileAvatar{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:flex;align-items:center;justify-content:center;color:#2a2000;font-family:"Fredoka One";font-size:40px;margin:0 auto 10px;}
.stats{display:flex;justify-content:center;gap:40px;margin:12px 0;color:var(--muted);}
.gamePage{max-width:900px;margin:0 auto;}
.previewLarge{width:100%;height:380px;border:0;border-radius:14px;background:#f3f3f3;}
.fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a2000;background:linear-gradient(135deg,var(--grad1),var(--grad2));box-shadow:0 10px 24px rgba(255,138,0,.35);cursor:pointer;z-index:25;}
.fab:hover{transform:translateY(-2px)}
/* Upload/editor */
.uploader{max-width:900px;margin:0 auto;}
.tabbar{display:flex;gap:10px;margin-top:10px}
.tabbar button{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.tabbar button.active{background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;border:0}
.editor{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:14px}
.previewEdit{width:100%;height:260px;border:0;border-radius:12px;background:#f3f3f3}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.counter{color:var(--muted);font-size:13px;margin-left:auto}
</style>
</head>
<body>

<header id="topbar" class="hidden">
  <div class="logo">Nebula Arcade</div>
  <div class="userMenu" id="userMenu">
    <div class="userBtn" id="userBtn">
      <div class="avatar" id="userAvatar">?</div>
      <span id="userNameTop">Cuenta</span>
    </div>
    <div class="dropdown" id="dropdown">
      <button id="viewProfileBtn" type="button">üë§ Ver perfil</button>
      <button id="logoutBtn" type="button">üö™ Cerrar sesi√≥n</button>
      <button id="deleteBtn" type="button" style="color:#b91c1c;display:none;">üóëÔ∏è Eliminar cuenta</button>
    </div>
  </div>
</header>

<!-- LOGIN / REGISTRO -->
<div class="wrapAuth" id="authView">
  <h1 style="font-family:'Fredoka One';text-align:center;">Nebula Arcade</h1>
  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="loginPass" type="password" placeholder="Contrase√±a">
    <button id="loginBtn" class="btn" style="width:100%" type="button">Iniciar sesi√≥n</button>
    <div id="loginStatus" class="status hidden"></div>
    <div id="loginError" class="error"></div>
    <span id="showSignup" class="link">¬øNo tienes cuenta? Reg√≠strate</span>
  </div>
  <div id="signupForm" class="hidden">
    <input id="nick" type="text" placeholder="Nombre o nickname">
    <input id="signupEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="signupPass" type="password" placeholder="Contrase√±a (m√≠n. 6)">
    <button id="signupBtn" class="btn" style="width:100%" type="button">Registrarse</button>
    <div id="signupStatus" class="status hidden"></div>
    <div id="signupError" class="error"></div>
    <span id="showLogin" class="link">¬øYa tienes cuenta? Inicia sesi√≥n</span>
  </div>
</div>

<!-- APP -->
<main id="appView" class="hidden">

  <!-- HOME -->
  <div id="homeView">
    <div class="searchBox">
      <input id="searchInput" type="text" placeholder="Buscar juegos por nombre...">
    </div>
    <div class="gamesGrid" id="gamesGrid"></div>
  </div>

  <!-- PERFIL -->
  <div id="profileView" class="hidden profileView">
    <div class="profileHeader">
      <div class="profileAvatar" id="profileAvatar">?</div>
      <h2 id="profileName">Usuario</h2>
      <div class="stats">
        <div>‚ù§Ô∏è <span id="likesCount">0</span> Likes</div>
        <div>üëÅÔ∏è <span id="visitsCount">0</span> Visitas</div>
      </div>
    </div>
    <h3 style="text-align:center;margin-bottom:8px;">Juegos subidos</h3>
    <div class="gamesGrid" id="userGamesGrid"></div>
    <div style="text-align:center;margin-top:16px;">
      <button id="backHomeBtn" class="btn" style="width:auto;" type="button">üè† Volver al inicio</button>
    </div>
  </div>

  <!-- GAME PAGE -->
  <div id="gameView" class="hidden gamePage">
    <iframe id="gamePreview" class="previewLarge" sandbox="allow-scripts"></iframe>
    <div class="gameHeader" style="display:flex;flex-direction:column;gap:6px;margin-top:10px">
      <h2 id="gameTitle">Nombre del juego</h2>
      <p id="gameDesc" class="metaMuted"></p>
      <div class="metaMuted">‚ù§Ô∏è <span id="likeCount">0</span> ¬∑ üëÅÔ∏è <span id="visitCount">0</span></div>
      <p>Creador: <span id="gameCreator" style="color:#ff8a00;font-weight:700;cursor:pointer;">Usuario</span></p>
      <div class="gameActions" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
        <button id="likeBtn" class="btn" style="padding:10px 16px" type="button">Like</button>
        <button id="dislikeBtn" class="btn" style="padding:10px 16px" type="button">Dislike</button>
        <button id="playBtn" class="btn" style="padding:14px 28px;font-weight:900" type="button">Jugar</button>
      </div>
      <div style="margin-top:16px"><button id="backHomeFromGame" class="btn" type="button">üè† Volver</button></div>
    </div>
  </div>

  <!-- UPLOAD -->
  <div id="uploadView" class="hidden uploader">
    <h2 style="text-align:center;margin-bottom:6px;">Subir nuevo juego</h2>
    <div class="row"><input id="gameNameIn" type="text" placeholder="Nombre del juego" style="flex:1"></div>
    <div class="row"><input id="gameDescIn" type="text" placeholder="Descripci√≥n corta" style="flex:1"></div>
    <div class="tabbar">
      <button id="tabEdit" class="active" type="button">Editor</button>
      <button id="tabPreview" type="button">Preview</button>
      <span class="counter" id="byteCounter">0 / 1,048,576 bytes</span>
    </div>
    <textarea id="codeEditor" class="editor" placeholder="Pega o escribe tu HTML + CSS + JS aqu√≠ (todo en uno)"></textarea>
    <iframe id="codePreview" class="previewEdit hidden" sandbox="allow-scripts"></iframe>
    <div class="row" style="margin-top:12px;justify-content:center;">
      <button id="submitGameBtn" class="btn" type="button">Subir juego</button>
      <button id="cancelUploadBtn" class="btn" style="background:#eee;color:#222;" type="button">Cancelar</button>
    </div>
  </div>

</main>

<!-- FAB -->
<button id="fab" class="fab hidden" title="Subir juego" type="button">+</button>

<script>
/* -------------------- Supabase -------------------- */
const SUPA_URL="https://arypwvzmjedlhsrzrgxw.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeXB3dnptamVkbGhzcnpyZ3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzgwNDgsImV4cCI6MjA3NTc1NDA0OH0.oLuc_NKB2xh0-43clDOSP0ShISP9shjdrSJgd0jo0uY";
const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/* -------------------- Persistencia manual extra -------------------- */
const NA_SESSION_KEY = "na_manual_session";
function saveSession(session){
  try{
    if(session?.access_token && session?.refresh_token){
      localStorage.setItem(NA_SESSION_KEY, JSON.stringify({
        access_token: session.access_token,
        refresh_token: session.refresh_token,
        ts: Date.now()
      }));
    }
  }catch(_){}
}
function clearSavedSession(){ try{ localStorage.removeItem(NA_SESSION_KEY); }catch(_){} }
async function restoreManualSessionIfNeeded(){
  const resp = await supabase.auth.getSession();
  const have = resp?.data?.session;
  if(have) return;
  try{
    const raw = localStorage.getItem(NA_SESSION_KEY);
    if(!raw) return;
    const { access_token, refresh_token } = JSON.parse(raw);
    if(access_token && refresh_token){
      await supabase.auth.setSession({ access_token, refresh_token });
    }
  }catch(e){ console.warn("restoreManualSessionIfNeeded error:", e); }
}

/* -------------------- Tokens de magic link en URL -------------------- */
(async function applyAuthFromUrl(){
  const usp=new URLSearchParams(location.search);
  const hash=location.hash.startsWith('#')?location.hash.slice(1):'';
  const hsp=new URLSearchParams(hash);
  const access_token=usp.get('access_token')||hsp.get('access_token');
  const refresh_token=usp.get('refresh_token')||hsp.get('refresh_token');
  if(access_token&&refresh_token){
    try{ await supabase.auth.setSession({access_token,refresh_token}); }
    catch(e){ console.warn("setSession failed:",e); }
    history.replaceState({},document.title,location.origin+location.pathname);
  }
})();

/* -------------------- refs & state -------------------- */
const $=id=>document.getElementById(id);
const topbar=$("topbar"), authView=$("authView"), appView=$("appView");
const homeView=$("homeView"), profileView=$("profileView"), gameView=$("gameView"), uploadView=$("uploadView");
const userMenu=$("userMenu"), userBtn=$("userBtn"), dropdown=$("dropdown");
const userAvatar=$("userAvatar"), userNameTop=$("userNameTop"), deleteBtn=$("deleteBtn");
const logoutBtn=$("logoutBtn"), viewProfileBtn=$("viewProfileBtn"), backHomeBtn=$("backHomeBtn");
const gamesGrid=$("gamesGrid"), userGamesGrid=$("userGamesGrid"), searchInput=$("searchInput");
const fab=$("fab");
const gamePreview=$("gamePreview"), gameTitle=$("gameTitle"), gameDesc=$("gameDesc"), likeCount=$("likeCount"), visitCount=$("visitCount"), gameCreator=$("gameCreator");
const likeBtn=$("likeBtn"), dislikeBtn=$("dislikeBtn"), playBtn=$("playBtn"), backHomeFromGame=$("backHomeFromGame");
const profileAvatar=$("profileAvatar"), profileName=$("profileName"), likesCount=$("likesCount"), visitsCount=$("visitsCount");
const gameNameIn=$("gameNameIn"), gameDescIn=$("gameDescIn"), codeEditor=$("codeEditor"), codePreview=$("codePreview");
const tabEdit=$("tabEdit"), tabPreview=$("tabPreview"), byteCounter=$("byteCounter");
const loginForm=$("loginForm"), signupForm=$("signupForm"), showSignup=$("showSignup"), showLogin=$("showLogin");
const loginEmail=$("loginEmail"), loginPass=$("loginPass"), loginBtn=$("loginBtn"), loginError=$("loginError"), loginStatus=$("loginStatus");
const signupBtn=$("signupBtn"), signupError=$("signupError"), signupStatus=$("signupStatus"), nick=$("nick"), signupEmail=$("signupEmail"), signupPass=$("signupPass");
const cancelUploadBtn=$("cancelUploadBtn"), submitGameBtn=$("submitGameBtn");

let currentUser=null;
let allGames=[];
let currentGame=null;
let viewingUserId=null;

/* -------------------- Utils -------------------- */
function closeDropdown(){ dropdown.style.display="none"; }
function bytesOf(str){ return new Blob([str||""]).size; }
function srcdocSafe(html){ return html || "<!doctype html><html><body>Empty</body></html>"; }
function nic(s){ return (s||"").trim(); }
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* -------------------- Diagn√≥stico activo -------------------- */
async function diagnoseConnectivity(labelEl){
  try{
    const headers={ apikey: SUPA_KEY, Authorization: `Bearer ${SUPA_KEY}` };
    const rest = await fetch(`${SUPA_URL}/rest/v1/?select=now()`, { headers });
    const auth = await fetch(`${SUPA_URL}/auth/v1/health`, { headers });
    const lines = [
      `üîé Diagn√≥stico:`,
      `REST now(): ${rest.status}`,
      `AUTH health: ${auth.status}`
    ];
    if(rest.status===403 || auth.status===403) lines.push("‚Üí CORS o dominio no permitido.");
    if(rest.status===401 || auth.status===401) lines.push("‚Üí Revisa tu anon key / proyecto.");
    labelEl.textContent = lines.join("\n");
  }catch(e){
    labelEl.textContent = "Diagn√≥stico: no se pudo conectar (red/CORS/extensi√≥n).";
  }
}

/* -------------------- Auth -------------------- */
showSignup.onclick=()=>{loginForm.classList.add("hidden");signupForm.classList.remove("hidden");};
showLogin.onclick=()=>{signupForm.classList.add("hidden");loginForm.classList.remove("hidden");};

signupBtn.onclick=async()=>{
  const nickname=nic(nick.value), email=nic(signupEmail.value), pass=signupPass.value;
  signupError.textContent=""; signupError.style.color="#b91c1c";
  signupStatus.textContent=""; signupStatus.classList.remove("hidden");
  if(!nickname||!email||!pass){ signupError.textContent="Completa todos los campos."; signupStatus.classList.add("hidden"); return;}
  if(pass.length<6){ signupError.textContent="La contrase√±a debe tener al menos 6 caracteres."; signupStatus.classList.add("hidden"); return;}
  signupStatus.innerHTML='<span class="loader"></span>Creando cuenta...';
  try{
    const {data,error}=await supabase.auth.signUp({email,password:pass,options:{data:{nickname}}});
    signupStatus.classList.add("hidden");
    if(error){ signupError.textContent="Error: "+error.message; return;}
    signupError.style.color="#2563eb";
    signupError.textContent="üìß Te enviamos un email de verificaci√≥n. Abre el enlace para entrar (revisa SPAM).";
  }catch(e){ signupError.textContent="Error inesperado: "+e.message; signupStatus.classList.add("hidden"); }
};

/* -------- Login con reintentos + fallback con setSession robusto -------- */
const LOGIN_MAX_ATTEMPTS = 2;
const LOGIN_TIMEOUT_MS = 7000;

async function sdkSignInWithTimeout(email, pass){
  let timer;
  const timeoutP = new Promise((_,rej)=>{ timer=setTimeout(()=>rej(new Error("TIMEOUT")), LOGIN_TIMEOUT_MS); });
  try{
    const result = await Promise.race([
      supabase.auth.signInWithPassword({ email, password: pass }),
      timeoutP
    ]);
    return result;
  } finally { clearTimeout(timer); }
}

async function rawPasswordLogin(email, pass){
  const url = `${SUPA_URL}/auth/v1/token?grant_type=password`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      "apikey": SUPA_KEY,
      "Authorization": `Bearer ${SUPA_KEY}`
    },
    body: JSON.stringify({ email, password: pass })
  });
  let payload = null;
  try { payload = await res.json(); } catch(_){}
  return { res, payload };
}

async function setSessionRobust(at, rt, statusEl){
  try{ await supabase.auth.setSession({ access_token: at, refresh_token: rt }); }catch(_){}
  for(let i=1;i<=12;i++){
    const sr = await supabase.auth.getSession();
    const s = sr?.data?.session;
    if(s?.access_token){
      saveSession(s);
      return true;
    }
    if(statusEl){ statusEl.textContent = `‚úÖ Tokens recibidos. Abriendo sesi√≥n‚Ä¶ (verificando ${i}/12)`; }
    await sleep(500);
    if(i===6){ try{ await supabase.auth.setSession({ access_token: at, refresh_token: rt }); }catch(_){ } }
  }
  return false;
}

loginBtn.onclick=async()=>{
  const email=nic(loginEmail.value), pass=loginPass.value;
  loginError.textContent=""; loginStatus.textContent=""; loginStatus.classList.remove("hidden");
  if(!email||!pass){ loginError.textContent="Rellena ambos campos."; loginStatus.classList.add("hidden"); return;}
  loginBtn.disabled=true;

  // 1) Reintentos con la SDK
  let lastErr="desconocido";
  for(let i=1;i<=LOGIN_MAX_ATTEMPTS;i++){
    loginStatus.textContent = `üîê Verificando credenciales‚Ä¶ (SDK intento ${i}/${LOGIN_MAX_ATTEMPTS})`;
    try{
      const { data, error } = await sdkSignInWithTimeout(email, pass);
      if(error){
        lastErr = error.message || String(error);
        if(error.message?.includes("Invalid login credentials")){
          loginStatus.classList.add("hidden");
          loginError.textContent = "‚ùå Credenciales incorrectas.";
          loginBtn.disabled=false;
          return;
        }
      }else if(data?.user){
        loginStatus.textContent = "‚úÖ Sesi√≥n iniciada. Cargando‚Ä¶";
        await loadUser(); showApp(); loadGames();
        loginStatus.classList.add("hidden");
        loginBtn.disabled=false;
        return;
      }else{
        lastErr = "Respuesta sin usuario (SDK).";
      }
    }catch(e){
      lastErr = (e.message==="TIMEOUT") ? "Tiempo de espera agotado." : (e.message||"Error desconocido");
      loginStatus.textContent = `‚ö†Ô∏è ${lastErr} (SDK intento ${i}/${LOGIN_MAX_ATTEMPTS})`;
    }
    await sleep(500*i);
  }

  // 2) Fallback real: POST directo a /auth/v1/token + setSession robusto
  loginStatus.textContent = "üõ†Ô∏è Intentando m√©todo alternativo‚Ä¶";
  try{
    const { res, payload } = await rawPasswordLogin(email, pass);
    if(res.ok && payload?.access_token && payload?.refresh_token){
      loginStatus.textContent = "‚úÖ Tokens recibidos. Abriendo sesi√≥n‚Ä¶";
      const ok = await setSessionRobust(payload.access_token, payload.refresh_token, loginStatus);
      if(ok){
        await loadUser(); showApp(); loadGames();
        loginStatus.classList.add("hidden");
        loginBtn.disabled=false;
        return;
      }else{
        loginError.textContent = "No se pudo establecer la sesi√≥n tras varios intentos.";
      }
    }else{
      const code = res.status;
      const msg  = payload?.error_description || payload?.msg || "Error en token";
      if(code===400 && /email/i.test(msg) && /confirm/i.test(msg)){
        loginError.textContent = "‚úâÔ∏è Tu email no est√° verificado. Revisa tu correo y confirma.";
      }else if(code===400 && /invalid login credentials/i.test(msg)){
        loginError.textContent = "‚ùå Credenciales incorrectas.";
      }else if(code===403){
        loginError.textContent = "403 (Forbidden). Puede ser CORS o configuraci√≥n de Auth.";
      }else{
        loginError.textContent = `‚ö†Ô∏è Fallback fall√≥ (${code}): ${msg}`;
      }
    }
  }catch(e){
    loginError.textContent = "Fallback error: "+(e.message||e);
  }

  await diagnoseConnectivity(loginStatus);
  loginBtn.disabled=false;
};

/* -------------------- Session & persist extra -------------------- */
supabase.auth.onAuthStateChange(async (_event, session)=>{
  if(session){ saveSession(session); } else { clearSavedSession(); }
  if(session){ await loadUser(); showApp(); loadGames(); } else { showAuth(); }
});

async function loadUser(){
  const resp = await supabase.auth.getUser();
  const user = resp?.data?.user || null;
  if(!user){ showAuth(); return;}
  currentUser=user;
  const nickn=user.user_metadata?.nickname||user.email;
  userAvatar.textContent=(nickn[0]||"?").toUpperCase();
  userNameTop.textContent=nickn;
  deleteBtn.style.display=(nickn.toLowerCase()==="pablodev")?"block":"none";
}

/* -------------------- Views helpers -------------------- */
function showAuth(){authView.classList.remove("hidden");appView.classList.add("hidden");topbar.classList.add("hidden");}
function showApp(){authView.classList.add("hidden");appView.classList.remove("hidden");topbar.classList.remove("hidden"); setView("home");}
function setView(v){
  homeView.classList.toggle("hidden", v!=="home");
  profileView.classList.toggle("hidden", v!=="profile");
  gameView.classList.toggle("hidden", v!=="game");
  uploadView.classList.toggle("hidden", v!=="upload");
  updateFab();
}

/* -------------------- Dropdown -------------------- */
userBtn.onclick=()=>{ dropdown.style.display = (dropdown.style.display==="flex")?"none":"flex"; dropdown.style.flexDirection="column"; };
window.addEventListener("click",(e)=>{ if(!userMenu.contains(e.target)) closeDropdown(); });
viewProfileBtn.onclick=()=>{ if(currentUser) openProfile(currentUser.id); closeDropdown(); };
logoutBtn.onclick=async()=>{ await supabase.auth.signOut(); clearSavedSession(); closeDropdown(); };
deleteBtn.onclick=async()=>{
  if(!currentUser) return;
  if(!confirm("¬øSeguro que quieres ELIMINAR tu cuenta y todos tus juegos?")) return;
  try{
    await supabase.from("games").delete().eq("creator_id", currentUser.id);
    await supabase.from("profiles").delete().eq("id", currentUser.id);
    await supabase.auth.signOut();
    clearSavedSession();
    alert("Cuenta eliminada (datos de juegos y perfil).");
  }catch(e){ alert("No se pudo eliminar todo. Revisa pol√≠ticas RLS."); }
  closeDropdown();
};

/* -------------------- Games: Load & Render -------------------- */
async function loadGames(){
  const {data, error}=await supabase
    .from("games")
    .select("id,creator_id,title,name,description,code,likes,dislikes,visits,created_at")
    .order("created_at",{ascending:false})
    .limit(200);
  if(error){
    console.warn("loadGames error", error);
    gamesGrid.innerHTML="<p class='metaMuted'>No se pudieron cargar los juegos (int√©ntalo m√°s tarde).</p>";
    return;
  }
  allGames = (data||[]).map(g=>({...g, title: g.title ?? g.name}));
  const ids=[...new Set(allGames.map(g=>g.creator_id).filter(Boolean))];
  let nameMap={};
  if(ids.length){
    const {data:profiles}=await supabase.from("profiles").select("id,nickname").in("id",ids);
    if(profiles){ for(const p of profiles) nameMap[p.id]=p.nickname; }
  }
  for(const g of allGames){ g.creator_name = nameMap[g.creator_id] || "Usuario"; }
  renderHome();
}
function renderHome(){
  const q=searchInput.value.trim().toLowerCase();
  const list = q? allGames.filter(g=> ((g.title||"").toLowerCase().includes(q))) : allGames;
  gamesGrid.innerHTML="";
  if(!list.length){ gamesGrid.innerHTML="<div class='metaMuted'>No se encontraron juegos.</div>"; return; }
  for(const g of list){
    const card=document.createElement("div"); card.className="gameCard";
    card.innerHTML=`
      <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
      <iframe class="cardPreview" sandbox="allow-scripts" loading="lazy"></iframe>
      <div class="metaMuted">Por ${escapeHtml(g.creator_name)} ¬∑ ‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>
    `;
    const iframe=card.querySelector("iframe");
    iframe.srcdoc = srcdocSafe(g.code);
    card.onclick=()=>openGame(g.id);
    gamesGrid.appendChild(card);
  }
}
searchInput.addEventListener("input", renderHome);

/* -------------------- Game Page -------------------- */
async function openGame(id){
  const g=allGames.find(x=>x.id===id);
  if(!g) return;
  currentGame = g;
  setView("game");
  gamePreview.srcdoc = srcdocSafe(g.code);
  gameTitle.textContent=g.title||"Sin t√≠tulo";
  gameDesc.textContent=g.description||"";
  likeCount.textContent=g.likes||0;
  visitCount.textContent=g.visits||0;
  gameCreator.textContent=g.creator_name||"Usuario";
  gameCreator.onclick=()=>openProfile(g.creator_id);

  try{
    const { data, error } = await supabase
      .from("games")
      .update({ visits: (g.visits||0)+1 })
      .eq("id", g.id)
      .select()
      .single();
    if(!error && data){ g.visits = data.visits; visitCount.textContent = g.visits; }
  }catch(e){ console.warn("visit update error", e); }
}
likeBtn.onclick=()=>vote("likes");
dislikeBtn.onclick=()=>vote("dislikes");
async function vote(field){
  if(!currentGame) return;
  const localNew = (currentGame[field]||0)+1;
  currentGame[field]=localNew;
  if(field==="likes") likeCount.textContent=localNew;
  try{
    await supabase.from("games").update({ [field]: localNew }).eq("id", currentGame.id);
  }catch(e){ console.warn("vote error", e); }
}
backHomeFromGame.onclick=()=>{ setView("home"); };

/* -------------------- Profile -------------------- */
async function openProfile(userId){
  viewingUserId = userId;
  setView("profile");
  let nick = "Usuario";
  if(currentUser && currentUser.id===userId){
    nick = currentUser.user_metadata?.nickname || currentUser.email;
  }else{
    const { data:prof } = await supabase.from("profiles").select("nickname").eq("id", userId).maybeSingle();
    if(prof?.nickname) nick = prof.nickname;
  }
  profileName.textContent = nick;
  profileAvatar.textContent = (nick[0]||"?").toUpperCase();

  const mine = allGames.filter(g=>g.creator_id===userId);
  const totalLikes = mine.reduce((a,b)=>a+(b.likes||0),0);
  const totalVisits = mine.reduce((a,b)=>a+(b.visits||0),0);
  likesCount.textContent = totalLikes;
  visitsCount.textContent = totalVisits;

  userGamesGrid.innerHTML="";
  if(!mine.length){
    const txt = (currentUser && currentUser.id===userId) ? "No has subido ning√∫n juego." : "No ha subido ning√∫n juego.";
    const noDiv = document.createElement("div");
    noDiv.className="metaMuted"; noDiv.style.textAlign="center"; noDiv.style.padding="12px";
    noDiv.textContent = txt;
    userGamesGrid.appendChild(noDiv);
  }else{
    for(const g of mine){
      const card=document.createElement("div"); card.className="gameCard";
      card.innerHTML=`
        <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
        <iframe class="cardPreview" sandbox="allow-scripts" loading="lazy"></iframe>
        <div class="metaMuted">‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>
      `;
      card.querySelector("iframe").srcdoc = srcdocSafe(g.code);
      card.onclick=()=>openGame(g.id);
      userGamesGrid.appendChild(card);
    }
  }
}
backHomeBtn.onclick=()=>setView("home");

/* -------------------- Upload (+) -------------------- */
const MAX_BYTES=1048576;
fab.onclick=()=>{ openUpload(); };
function openUpload(){
  if(!currentUser){ alert("Inicia sesi√≥n para subir juegos."); return; }
  setView("upload");
  gameNameIn.value=""; gameDescIn.value=""; codeEditor.value="";
  codePreview.srcdoc=""; updateByteCounter();
  tabTo("edit");
}
cancelUploadBtn.onclick=()=>setView("home");
tabEdit.onclick=()=>tabTo("edit");
tabPreview.onclick=()=>tabTo("preview");
codeEditor.addEventListener("input", ()=>{ updateByteCounter(); if(tabPreview.classList.contains("active")) refreshEditPreview(); });
function tabTo(which){
  if(which==="edit"){
    tabEdit.classList.add("active"); tabPreview.classList.remove("active");
    codeEditor.classList.remove("hidden"); codePreview.classList.add("hidden");
  }else{
    tabPreview.classList.add("active"); tabEdit.classList.remove("active");
    codeEditor.classList.add("hidden"); codePreview.classList.remove("hidden");
    refreshEditPreview();
  }
}
function refreshEditPreview(){ codePreview.srcdoc = srcdocSafe(codeEditor.value); }
function updateByteCounter(){ const n=bytesOf(codeEditor.value); byteCounter.textContent = `${n.toLocaleString()} / ${MAX_BYTES.toLocaleString()} bytes`; }

submitGameBtn.onclick=async()=>{
  if(!currentUser){ alert("Inicia sesi√≥n."); return; }
  const title = nic(gameNameIn.value), description=nic(gameDescIn.value), code=codeEditor.value;
  if(!title || !code){ alert("Pon al menos nombre y c√≥digo."); return; }
  const size=bytesOf(code);
  if(size>MAX_BYTES){ alert("Tu juego supera 1 MB."); return; }
  const creator_name = currentUser.user_metadata?.nickname || currentUser.email;
  try{
    const { data, error } = await supabase.from("games").insert({
      creator_id: currentUser.id, title, description, code, likes: 0, dislikes: 0, visits: 0
    }).select().single();
    if(error) throw error;
    const game = { ...data, creator_name };
    allGames.unshift(game);
    renderHome();
    openGame(game.id);
  }catch(e){
    console.warn("upload error", e);
    alert("No se pudo subir el juego. Revisa RLS/pol√≠ticas de la tabla.");
  }
};

/* -------------------- FAB visibility -------------------- */
function updateFab(){
  const showFab = !!currentUser && !homeView.classList.contains("hidden");
  fab.classList.toggle("hidden", !showFab);
}

/* -------------------- Init -------------------- */
(async function init(){
  try {
    await restoreManualSessionIfNeeded();
    const sessionResp = await supabase.auth.getSession();
    const activeSession = sessionResp && sessionResp.data ? sessionResp.data.session : null;

    if (activeSession) {
      await loadUser();
      showApp();
      loadGames();
    } else {
      showAuth();
    }

    const obs = new MutationObserver(updateFab);
    obs.observe(homeView, { attributes: true, attributeFilter: ["class"] });

    ["viewProfileBtn", "logoutBtn", "deleteBtn"].forEach(id => {
      const el = $(id);
      if (el) el.addEventListener("click", () => closeDropdown());
    });

    console.log("‚úÖ Nebula Arcade iniciado.");
  } catch (err) {
    console.error("‚ùå Error en init:", err);
    showAuth();
  }
})();
</script>
</body>
</html>
