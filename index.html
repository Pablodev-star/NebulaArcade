<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Nebula Arcade</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --grad1:#ff8a00;--grad2:#ffd200;--text:#1b1f24;--border:#e5e7eb;--muted:#6b7280;--bg:#fff;
  --ok:#16a34a;--warn:#b91c1c;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui;background:var(--bg);color:var(--text);}

/* Topbar */
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:20;backdrop-filter:saturate(1.1) blur(4px)}
.logo{font-family:"Fredoka One";font-size:22px;background:linear-gradient(90deg,var(--grad1),var(--grad2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.userMenu{position:relative;}
.userBtn{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;font-weight:700;cursor:pointer;transition:.2s;box-shadow:0 8px 18px rgba(255,138,0,.25);transform:translateZ(0)}
.userBtn:hover{filter:brightness(1.06);transform:translateY(-1px)}
.userBtn:active{transform:translateY(0)}
.avatar{width:28px;height:28px;border-radius:50%;background:#fff;color:#2a2000;display:flex;align-items:center;justify-content:center;font-family:"Fredoka One"; box-shadow:0 2px 8px rgba(0,0,0,.12)}
.dropdown{position:absolute;right:0;top:110%;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.15);display:none;flex-direction:column;min-width:200px;overflow:hidden;z-index:30}
.dropdown button{background:none;border:0;text-align:left;padding:12px 16px;cursor:pointer;font-weight:600;color:var(--text);transition:.15s;width:100%}
.dropdown button:hover{background:#fafafa}

/* Main & grids */
main{max-width:1000px;margin:24px auto 90px;padding:0 18px}
.searchBox{margin-bottom:18px;display:flex;gap:10px}
.searchBox input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:15px;transition:.15s}
.searchBox input:focus{border-color:#ffd24d;outline:none;box-shadow:0 0 0 4px #ffe08d60}
.gamesGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.gameCard{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 10px 26px rgba(0,0,0,.06);padding:12px;transition:.2s;cursor:pointer;display:flex;flex-direction:column;gap:8px;transform:translateZ(0)}
.gameCard:hover{transform:translateY(-4px)}
.cardTitle{font-weight:800}
.cardPreview{width:100%;height:140px;border:0;border-radius:12px;background:#f3f3f3;pointer-events:none}
.metaMuted{color:var(--muted);font-size:13px}
.hidden{display:none}

/* Auth */
.wrapAuth{max-width:420px;margin:10vh auto;padding:24px;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.08);background:#fff}
input{width:100%;padding:12px;margin:6px 0;border:1px solid var(--border);border-radius:12px;font-size:15px;transition:.15s}
input:focus{box-shadow:0 0 0 4px #ffe08d60;border-color:#ffd24d;outline:none}
.btn{border:0;border-radius:12px;padding:12px 20px;font-weight:800;cursor:pointer;color:#2a2000;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:.15s;box-shadow:0 8px 18px rgba(255,138,0,.25);transform:translateZ(0)}
.btn:hover{background:linear-gradient(90deg,#ffa12b,#ffe04d);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn--danger{background:linear-gradient(90deg,#ff6961,#ffd200)}
.error{color:var(--warn);font-size:14px;margin-top:6px;text-align:center;white-space:pre-line}
.status{color:#2563eb;font-size:14px;margin-top:6px;text-align:center;white-space:pre-line}
.loader{display:inline-block;width:16px;height:16px;border:3px solid #ffd24d;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
.link{color:var(--muted);font-size:14px;text-decoration:underline;cursor:pointer;text-align:center;display:block;margin-top:12px}

/* Perfil */
.profileView{max-width:700px;margin:0 auto}
.profileHeader{text-align:center;margin-bottom:16px}
.profileAvatar{width:96px;height:96px;border-radius:50%;background:linear-gradient(135deg,var(--grad1),var(--grad2));display:flex;align-items:center;justify-content:center;color:#2a2000;font-family:"Fredoka One";font-size:40px;margin:0 auto 10px;box-shadow:0 10px 22px rgba(255,138,0,.25)}
.stats{display:flex;justify-content:center;gap:40px;margin:12px 0;color:var(--muted)}

/* P√°gina de juego */
.gamePage{max-width:900px;margin:0 auto}
.previewLarge{width:100%;height:380px;border:0;border-radius:14px;background:#f3f3f3;pointer-events:none;box-shadow:0 12px 28px rgba(0,0,0,.08)}
.gameHeader{display:flex;flex-direction:column;gap:6px;margin-top:10px}
.gameActions{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.toggleBtn{position:relative}
.toggleBtn.active::after{content:"";position:absolute;inset:-3px;border-radius:14px;box-shadow:0 0 0 3px #ffe08da6;pointer-events:none}

/* FAB subir juego */
.fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;color:#2a2000;background:linear-gradient(135deg,var(--grad1),var(--grad2));box-shadow:0 12px 28px rgba(255,138,0,.35);cursor:pointer;z-index:25}
.fab:hover{transform:translateY(-2px)}

/* Uploader */
.uploader{max-width:900px;margin:0 auto}
.tabbar{display:flex;gap:10px;margin-top:10px}
.tabbar button{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;transition:.15s}
.tabbar button.active{background:linear-gradient(90deg,var(--grad1),var(--grad2));color:#2a2000;border:0;box-shadow:0 8px 18px rgba(255,138,0,.25)}
.editor{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:14px}
.previewEdit{width:100%;height:260px;border:0;border-radius:12px;background:#f3f3f3}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.counter{color:var(--muted);font-size:13px;margin-left:auto}

/* Fullscreen Player (sin textos) */
.playerFS{position:fixed;inset:0;background:#000;display:none;z-index:60}
.fsFrame{position:absolute;inset:0;width:100%;height:100%;border:0}
.fsClose{position:absolute;top:12px;right:12px;border:0;border-radius:999px;background:rgba(255,255,255,.9);color:#111;padding:8px 12px;font-weight:900;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.35)}
.fsClose:hover{background:#fff}

/* Animaciones base */
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header id="topbar" class="hidden">
  <div class="logo">Nebula Arcade</div>
  <div class="userMenu" id="userMenu">
    <div class="userBtn" id="userBtn">
      <div class="avatar" id="userAvatar">?</div>
      <span id="userNameTop">Cuenta</span>
    </div>
    <div class="dropdown" id="dropdown">
      <button id="viewProfileBtn" type="button">üë§ Ver perfil</button>
      <button id="logoutBtn" type="button">üö™ Cerrar sesi√≥n</button>
      <button id="deleteBtn" type="button" style="color:#b91c1c;display:none;">üóëÔ∏è Eliminar cuenta</button>
    </div>
  </div>
</header>

<!-- LOGIN / REGISTRO -->
<div class="wrapAuth" id="authView">
  <h1 style="font-family:'Fredoka One';text-align:center;">Nebula Arcade</h1>
  <div id="loginForm">
    <input id="loginEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="loginPass" type="password" placeholder="Contrase√±a">
    <button id="loginBtn" class="btn" style="width:100%" type="button">Iniciar sesi√≥n</button>
    <div id="loginStatus" class="status hidden"></div>
    <div id="loginError" class="error"></div>
    <span id="showSignup" class="link">¬øNo tienes cuenta? Reg√≠strate</span>
  </div>
  <div id="signupForm" class="hidden">
    <input id="nick" type="text" placeholder="Nombre o nickname">
    <input id="signupEmail" type="email" placeholder="Correo electr√≥nico">
    <input id="signupPass" type="password" placeholder="Contrase√±a (m√≠n. 6)">
    <button id="signupBtn" class="btn" style="width:100%" type="button">Registrarse</button>
    <div id="signupStatus" class="status hidden"></div>
    <div id="signupError" class="error"></div>
    <span id="showLogin" class="link">¬øYa tienes cuenta? Inicia sesi√≥n</span>
  </div>
</div>

<!-- APP -->
<main id="appView" class="hidden">

  <!-- HOME -->
  <div id="homeView">
    <div class="searchBox">
      <input id="searchInput" type="text" placeholder="Buscar juegos por nombre...">
    </div>
    <div class="gamesGrid" id="gamesGrid"></div>
  </div>

  <!-- PERFIL -->
  <div id="profileView" class="hidden profileView">
    <div class="profileHeader">
      <div class="profileAvatar" id="profileAvatar">?</div>
      <h2 id="profileName">Usuario</h2>
      <div class="stats">
        <div>‚ù§Ô∏è <span id="likesCount">0</span> Likes</div>
        <div>üëÅÔ∏è <span id="visitsCount">0</span> Visitas</div>
      </div>
    </div>
    <h3 style="text-align:center;margin-bottom:8px;">Juegos subidos</h3>
    <div class="gamesGrid" id="userGamesGrid"></div>
    <div style="text-align:center;margin-top:16px;">
      <button id="backHomeBtn" class="btn" style="width:auto;" type="button">üè† Volver al inicio</button>
    </div>
  </div>

  <!-- GAME PAGE -->
  <div id="gameView" class="hidden gamePage">
    <iframe id="gamePreview" class="previewLarge" sandbox="allow-scripts"></iframe>
    <div class="gameHeader">
      <h2 id="gameTitle">Nombre del juego</h2>
      <p id="gameDesc" class="metaMuted"></p>
      <div class="metaMuted">‚ù§Ô∏è <span id="likeCount">0</span> ¬∑ üëÅÔ∏è <span id="visitCount">0</span></div>
      <p>Creador: <span id="gameCreator" style="color:#ff8a00;font-weight:700;cursor:pointer;">Usuario</span></p>
      <div class="gameActions">
        <button id="likeBtn" class="btn toggleBtn" type="button">Like</button>
        <button id="dislikeBtn" class="btn toggleBtn" type="button">Dislike</button>
        <button id="playBtn" class="btn" style="padding:14px 28px;font-weight:900" type="button">Jugar</button>
        <button id="deleteGameBtn" class="btn btn--danger hidden" type="button">üóëÔ∏è Eliminar juego</button>
      </div>
      <div style="margin-top:16px"><button id="backHomeFromGame" class="btn" type="button">üè† Volver</button></div>
    </div>
  </div>

  <!-- UPLOAD -->
  <div id="uploadView" class="hidden uploader">
    <h2 style="text-align:center;margin-bottom:6px;">Subir nuevo juego</h2>
    <div class="row"><input id="gameNameIn" type="text" placeholder="Nombre del juego" style="flex:1"></div>
    <div class="row"><input id="gameDescIn" type="text" placeholder="Descripci√≥n corta" style="flex:1"></div>
    <div class="tabbar">
      <button id="tabEdit" class="active" type="button">Editor</button>
      <button id="tabPreview" type="button">Preview</button>
      <span class="counter" id="byteCounter">0 / 1,048,576 bytes</span>
    </div>
    <textarea id="codeEditor" class="editor" placeholder="Pega o escribe tu HTML + CSS + JS aqu√≠ (todo en uno)"></textarea>
    <iframe id="codePreview" class="previewEdit hidden" sandbox="allow-scripts"></iframe>
    <div class="row" style="margin-top:12px;justify-content:center;">
      <button id="submitGameBtn" class="btn" type="button">Subir juego</button>
      <button id="cancelUploadBtn" class="btn" style="background:#eee;color:#222;" type="button">Cancelar</button>
    </div>
  </div>

</main>

<!-- FAB -->
<button id="fab" class="fab hidden" title="Subir juego" type="button">+</button>

<!-- FULLSCREEN PLAYER (sin textos, solo juego + salir) -->
<div id="playerFS" class="playerFS" style="display:none;">
  <iframe id="fsFrame" class="fsFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  <button id="fsClose" class="fsClose" type="button">Salir</button>
</div>

<script>
/* ========= Config & Auth (REST) ========= */
const SUPA_URL="https://arypwvzmjedlhsrzrgxw.supabase.co";
const SUPA_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyeXB3dnptamVkbGhzcnpyZ3h3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzgwNDgsImV4cCI6MjA3NTc1NDA0OH0.oLuc_NKB2xh0-43clDOSP0ShISP9shjdrSJgd0jo0uY";

const SESSION_KEY="na_session_v1";
let session=null;
function loadSession(){ try{session=JSON.parse(localStorage.getItem(SESSION_KEY)||"null");}catch{session=null;} }
function saveSession(s){ session=s; localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
function clearSession(){ session=null; localStorage.removeItem(SESSION_KEY); }

async function ensureFreshToken(){
  if(!session) return;
  const now = Math.floor(Date.now()/1000);
  if(session.expires_at && session.expires_at - now > 60) return;
  const res = await fetch(`${SUPA_URL}/auth/v1/token?grant_type=refresh_token`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` },
    body: JSON.stringify({ refresh_token: session.refresh_token })
  });
  const data = await res.json().catch(()=>null);
  if(!res.ok || !data?.access_token) throw new Error("No se pudo refrescar token");
  const expires_at = now + (data.expires_in||3600);
  saveSession({ access_token:data.access_token, refresh_token:data.refresh_token||session.refresh_token, expires_at, user: session.user });
}
async function rest(method, path, { query=null, body=null }={}){
  await ensureFreshToken();
  const qs = query ? "?"+new URLSearchParams(query).toString() : "";
  const res = await fetch(`${SUPA_URL}${path}${qs}`,{
    method,
    headers:{
      apikey: SUPA_KEY,
      Authorization: session? `Bearer ${session.access_token}` : `Bearer ${SUPA_KEY}`,
      "Content-Type":"application/json",
      "Prefer":"return=representation"
    },
    body: body? JSON.stringify(body): null
  });
  const text = await res.text();
  let json=null; try{ json = text? JSON.parse(text): null; }catch{ json=null; }
  if(!res.ok) throw new Error(json?.message || json?.error_description || json?.msg || `HTTP ${res.status}`);
  return json;
}
async function signUp(email,password,nickname){
  return rest("POST","/auth/v1/signup",{ body:{ email, password, data:{ nickname } } });
}
async function login(email,password){
  const now=Math.floor(Date.now()/1000);
  const res = await fetch(`${SUPA_URL}/auth/v1/token?grant_type=password`,{
    method:"POST",
    headers:{ "Content-Type":"application/json", apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` },
    body: JSON.stringify({ email, password })
  });
  const data = await res.json().catch(()=>null);
  if(!res.ok || !data?.access_token) throw new Error(data?.error_description || "No se pudo iniciar sesi√≥n");
  const ures = await fetch(`${SUPA_URL}/auth/v1/user`,{ headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${data.access_token}` }});
  const user = await ures.json().catch(()=>null);
  if(!ures.ok) throw new Error("No se pudo obtener el usuario");
  const expires_at = now + (data.expires_in||3600);
  saveSession({ access_token:data.access_token, refresh_token:data.refresh_token, expires_at, user });
}
async function logout(){
  if(session){
    try{
      await fetch(`${SUPA_URL}/auth/v1/logout`,{ method:"POST", headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${session.access_token}` } });
    }catch{}
  }
  clearSession();
}

/* ========= DOM ========= */
const $=id=>document.getElementById(id);
const topbar=$("topbar"), authView=$("authView"), appView=$("appView");
const homeView=$("homeView"), profileView=$("profileView"), gameView=$("gameView"), uploadView=$("uploadView");
const userMenu=$("userMenu"), userBtn=$("userBtn"), dropdown=$("dropdown");
const userAvatar=$("userAvatar"), userNameTop=$("userNameTop"), deleteBtn=$("deleteBtn");
const logoutBtn=$("logoutBtn"), viewProfileBtn=$("viewProfileBtn"), backHomeBtn=$("backHomeBtn");
const gamesGrid=$("gamesGrid"), userGamesGrid=$("userGamesGrid"), searchInput=$("searchInput");
const fab=$("fab");
const gamePreview=$("gamePreview"), gameTitle=$("gameTitle"), gameDesc=$("gameDesc"), likeCount=$("likeCount"), visitCount=$("visitCount"), gameCreator=$("gameCreator");
const likeBtn=$("likeBtn"), dislikeBtn=$("dislikeBtn"), playBtn=$("playBtn"), backHomeFromGame=$("backHomeFromGame"), deleteGameBtn=$("deleteGameBtn");
const profileAvatar=$("profileAvatar"), profileName=$("profileName"), likesCount=$("likesCount"), visitsCount=$("visitsCount");
const gameNameIn=$("gameNameIn"), gameDescIn=$("gameDescIn"), codeEditor=$("codeEditor"), codePreview=$("codePreview");
const tabEdit=$("tabEdit"), tabPreview=$("tabPreview"), byteCounter=$("byteCounter");
const loginForm=$("loginForm"), signupForm=$("signupForm"), showSignup=$("showSignup"), showLogin=$("showLogin");
const loginEmail=$("loginEmail"), loginPass=$("loginPass"), loginBtn=$("loginBtn"), loginError=$("loginError"), loginStatus=$("loginStatus");
const signupBtn=$("signupBtn"), signupError=$("signupError"), signupStatus=$("signupStatus"), nick=$("nick"), signupEmail=$("signupEmail"), signupPass=$("signupPass");
const cancelUploadBtn=$("cancelUploadBtn"), submitGameBtn=$("submitGameBtn");
const playerFS=$("playerFS"), fsFrame=$("fsFrame"), fsClose=$("fsClose");

/* ========= Estado ========= */
let currentUser=null;
let allGames=[];
let currentGame=null;
let viewingUserId=null;
let currentVote=null;

/* ========= Utils ========= */
function closeDropdown(){ dropdown.style.display="none"; }
function bytesOf(str){ return new Blob([str||""]).size; }
function srcdocSafe(html){ return html || "<!doctype html><html><body>Empty</body></html>"; }
function nic(s){ return (s||"").trim(); }
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function isAdmin(){ return (currentUser?.email||"").toLowerCase()==="pablomassofia@gmail.com"; }

/* ========= Auth UI ========= */
showSignup.onclick=()=>{loginForm.classList.add("hidden");signupForm.classList.remove("hidden");};
showLogin.onclick=()=>{signupForm.classList.add("hidden");loginForm.classList.remove("hidden");};

signupBtn.onclick=async()=>{
  const nickname=nic(nick.value), email=nic(signupEmail.value), pass=signupPass.value;
  signupError.textContent=""; signupError.style.color="#b91c1c";
  signupStatus.textContent=""; signupStatus.classList.remove("hidden");
  if(!nickname||!email||!pass){ signupError.textContent="Completa todos los campos."; signupStatus.classList.add("hidden"); return;}
  if(pass.length<6){ signupError.textContent="La contrase√±a debe tener al menos 6 caracteres."; signupStatus.classList.add("hidden"); return;}
  signupStatus.innerHTML='<span class="loader"></span>Creando cuenta...';
  try{
    const data = await signUp(email,pass,nickname);
    signupStatus.classList.add("hidden");
    if(data?.user?.identities?.length===0){ signupError.textContent="Ese correo ya est√° registrado."; return; }
    signupError.style.color="#2563eb";
    signupError.textContent="üìß Revisa tu email para verificar la cuenta (puede ir a SPAM).";
  }catch(e){
    signupStatus.classList.add("hidden");
    signupError.textContent="Error: "+(e.message||e);
  }
};

loginBtn.onclick=async()=>{
  const email=nic(loginEmail.value), pass=loginPass.value;
  loginError.textContent=""; loginStatus.textContent=""; loginStatus.classList.remove("hidden");
  if(!email||!pass){ loginError.textContent="Rellena ambos campos."; loginStatus.classList.add("hidden"); return;}
  loginBtn.disabled=true;
  loginStatus.innerHTML='<span class="loader"></span>Verificando credenciales...';
  try{
    await login(email,pass);
    loginStatus.textContent="‚úÖ Sesi√≥n iniciada. Cargando‚Ä¶";
    await afterLoginBoot();
  }catch(e){
    const msg=(e.message||"").toLowerCase();
    if(msg.includes("invalid login credentials")) loginError.textContent="‚ùå Credenciales incorrectas.";
    else if(msg.includes("email") && msg.includes("confirm")) loginError.textContent="‚úâÔ∏è Tu email no est√° verificado.";
    else loginError.textContent="‚ö†Ô∏è "+(e.message||e);
    await diagnose(loginStatus);
  }finally{ loginBtn.disabled=false; }
};

async function afterLoginBoot(){
  loadSession();
  if(!session || !session.user){ loginError.textContent="‚ö†Ô∏è Sesi√≥n no disponible tras login."; return; }
  currentUser = session.user;
  setTopbarUser(currentUser);
  showApp();
  try{ await loadGames(); }catch(e){ gamesGrid.innerHTML="<div class='metaMuted'>No se pudieron cargar los juegos.</div>"; }
  loginStatus.classList.add("hidden");
}

/* ========= Topbar & vistas ========= */
function setTopbarUser(u){
  const nick=u?.user_metadata?.nickname || u?.email || "Usuario";
  userAvatar.textContent=(nick[0]||"?").toUpperCase();
  userNameTop.textContent=nick;
  deleteBtn.style.display=(nick.toLowerCase()==="pablodev")?"block":"none"; /* legado */
}
function showAuth(){authView.classList.remove("hidden");appView.classList.add("hidden");topbar.classList.add("hidden");}
function showApp(){authView.classList.add("hidden");appView.classList.remove("hidden");topbar.classList.remove("hidden"); setView("home");}
function setView(v){
  homeView.classList.toggle("hidden", v!=="home");
  profileView.classList.toggle("hidden", v!=="profile");
  gameView.classList.toggle("hidden", v!=="game");
  uploadView.classList.toggle("hidden", v!=="upload");
  updateFab();
}

viewProfileBtn.onclick=()=>{ if(currentUser) openProfile(currentUser.id); closeDropdown(); };
logoutBtn.onclick=async()=>{ await logout(); currentUser=null; showAuth(); closeDropdown(); };
userBtn.onclick=()=>{ dropdown.style.display=(dropdown.style.display==="flex")?"none":"flex"; dropdown.style.flexDirection="column"; };
window.addEventListener("click",(e)=>{ if(!userMenu.contains(e.target)) closeDropdown(); });

deleteBtn.onclick=async()=>{
  if(!currentUser) return;
  if(!confirm("¬øEliminar tu cuenta y juegos?")) return;
  try{
    await rest("DELETE","/rest/v1/games",{ query:{ creator_id:`eq.${currentUser.id}` } });
    await rest("DELETE","/rest/v1/profiles",{ query:{ id:`eq.${currentUser.id}` } });
    await logout();
    alert("Cuenta eliminada (datos de juegos y perfil).");
    showAuth();
  }catch(e){ alert("No se pudo eliminar todo. RLS/Pol√≠ticas: "+(e.message||e)); }
  closeDropdown();
};

/* ========= Diagn√≥stico simple ========= */
async function diagnose(label){
  try{
    const r1 = await fetch(`${SUPA_URL}/rest/v1/?select=now()`, { headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` }});
    const r2 = await fetch(`${SUPA_URL}/auth/v1/health`, { headers:{ apikey:SUPA_KEY, Authorization:`Bearer ${SUPA_KEY}` }});
    label.textContent = `üîé REST: ${r1.status} ¬∑ AUTH: ${r2.status}`;
  }catch{ label.textContent="üîé No hay conexi√≥n (CORS/red)"; }
}

/* ========= Games ========= */
async function loadGames(){
  const params = { select:"id,creator_id,title,description,code,likes,dislikes,visits,created_at", order:"created_at.desc", limit:200 };
  const data = await rest("GET","/rest/v1/games",{ query:params });
  allGames = data || [];
  const ids=[...new Set(allGames.map(g=>g.creator_id).filter(Boolean))];
  let nameMap={};
  if(ids.length){
    const list = `(${ids.map(x=>`"${x}"`).join(",")})`;
    const profs = await rest("GET","/rest/v1/profiles",{ query:{ select:"id,nickname", id:`in.${list}` } });
    (profs||[]).forEach(p=>{ nameMap[p.id]=p.nickname; });
  }
  allGames.forEach(g=> g.creator_name = nameMap[g.creator_id] || "Usuario");
  renderHome();
}
function renderHome(){
  const q=searchInput.value.trim().toLowerCase();
  const list = q? allGames.filter(g=> ((g.title||"").toLowerCase().includes(q))) : allGames;
  gamesGrid.innerHTML="";
  if(!list.length){ gamesGrid.innerHTML="<div class='metaMuted'>No se encontraron juegos.</div>"; return; }
  list.forEach((g)=>{
    const card=document.createElement("div"); card.className="gameCard";
    card.innerHTML=`
      <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
      <iframe class="cardPreview" sandbox="allow-scripts" loading="lazy"></iframe>
      <div class="metaMuted">Por ${escapeHtml(g.creator_name)} ¬∑ ‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>`;
    card.querySelector("iframe").srcdoc = srcdocSafe(g.code);
    card.onclick=()=>openGame(g.id);
    gamesGrid.appendChild(card);
  });
}
searchInput.addEventListener("input", renderHome);

/* ========= Game Page + Votos ========= */
async function openGame(id){
  const g=allGames.find(x=>x.id===id); if(!g) return;
  currentGame = g; currentVote=null;
  setView("game");
  gamePreview.srcdoc = srcdocSafe(g.code);
  gameTitle.textContent=g.title||"Sin t√≠tulo";
  gameDesc.textContent=g.description||"";
  likeCount.textContent=g.likes||0; visitCount.textContent=g.visits||0;
  gameCreator.textContent=g.creator_name||"Usuario";
  gameCreator.onclick=()=>openProfile(g.creator_id);

  // Mostrar bot√≥n borrar si creador o admin
  const canDelete = currentUser && (currentUser.id===g.creator_id || isAdmin());
  deleteGameBtn.classList.toggle("hidden", !canDelete);

  // Cargar mi voto (si estoy logueado)
  if(currentUser){
    try{
      const rows = await rest("GET","/rest/v1/votes",{ query:{ select:"id,type", user_id:`eq.${currentUser.id}`, game_id:`eq.${g.id}` }});
      currentVote = rows?.[0] || null;
      syncVoteButtons();
    }catch(_){ /* ignorar */ }
  }else{
    currentVote=null; syncVoteButtons();
  }
}
function syncVoteButtons(){
  likeBtn.classList.toggle("active", currentVote?.type==="like");
  dislikeBtn.classList.toggle("active", currentVote?.type==="dislike");
}
likeBtn.onclick = ()=>handleVote("like");
dislikeBtn.onclick = ()=>handleVote("dislike");

async function handleVote(type){
  if(!currentUser || !currentGame) { alert("Inicia sesi√≥n para votar."); return; }
  const g=currentGame;
  const prev = currentVote?.type || null;

  try{
    if(prev===type){
      // Quitar voto
      if(currentVote?.id){
        await rest("DELETE","/rest/v1/votes",{ query:{ id:`eq.${currentVote.id}` }});
      }
      currentVote=null;
      if(type==="like"){
        g.likes=Math.max(0,(g.likes||0)-1); likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes } });
      }else{
        g.dislikes=Math.max(0,(g.dislikes||0)-1);
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ dislikes:g.dislikes } });
      }
    }else if(prev===null){
      // Insert nuevo voto
      const ins = await rest("POST","/rest/v1/votes",{ body:{ user_id:currentUser.id, game_id:g.id, type }});
      currentVote = ins?.[0] || null;
      if(type==="like"){
        g.likes=(g.likes||0)+1; likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes } });
      }else{
        g.dislikes=(g.dislikes||0)+1;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ dislikes:g.dislikes } });
      }
    }else{
      // Cambiar voto
      if(currentVote?.id){
        const upd = await rest("PATCH","/rest/v1/votes",{ query:{ id:`eq.${currentVote.id}` }, body:{ type }});
        currentVote = upd?.[0] || null;
      }else{
        const ins2 = await rest("POST","/rest/v1/votes",{ body:{ user_id:currentUser.id, game_id:g.id, type }});
        currentVote = ins2?.[0] || null;
      }
      if(type==="like"){
        g.likes=(g.likes||0)+1; likeCount.textContent=g.likes;
        g.dislikes=Math.max(0,(g.dislikes||0)-1);
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes, dislikes:g.dislikes } });
      }else{
        g.dislikes=(g.dislikes||0)+1;
        g.likes=Math.max(0,(g.likes||0)-1); likeCount.textContent=g.likes;
        await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${g.id}` }, body:{ likes:g.likes, dislikes:g.dislikes } });
      }
    }
  }catch(e){
    console.warn("vote error", e);
    alert("No se pudo registrar el voto (RLS/pol√≠ticas).");
  }finally{
    syncVoteButtons();
  }
}

/* ========= JUGAR en pantalla completa ========= */
playBtn.onclick = async () => {
  if(!currentGame) return;
  // abrir FS
  document.body.style.overflow="hidden";
  playerFS.style.display="block";
  fsFrame.srcdoc = srcdocSafe(currentGame.code);

  // contar visita (solo al jugar)
  try{
    const updated = await rest("PATCH","/rest/v1/games",{ query:{ id:`eq.${currentGame.id}` }, body:{ visits:(currentGame.visits||0)+1 } });
    if(updated?.[0]){ currentGame.visits=updated[0].visits; visitCount.textContent=currentGame.visits; }
  }catch(_){}
};
fsClose.onclick = () => {
  fsFrame.srcdoc="";
  playerFS.style.display="none";
  document.body.style.overflow="";
};

/* ========= Eliminar juego ========= */
deleteGameBtn.onclick = async ()=>{
  if(!currentUser || !currentGame) return;
  const g=currentGame;
  const canDelete = (currentUser.id===g.creator_id) || isAdmin();
  if(!canDelete){ alert("No tienes permisos para borrar este juego."); return; }
  if(!confirm(`¬øEliminar "${g.title||'este juego'}"?`)) return;
  try{
    await rest("DELETE","/rest/v1/games",{ query:{ id:`eq.${g.id}` } });
    allGames = allGames.filter(x=>x.id!==g.id);
    setView("home"); renderHome();
  }catch(e){
    alert("No se pudo eliminar (RLS). Si eres admin y falla, ajusta pol√≠ticas de DELETE en public.games");
  }
};

/* ========= Perfil ========= */
async function openProfile(userId){
  viewingUserId=userId; setView("profile");
  let nickTxt="Usuario";
  if(currentUser && currentUser.id===userId) nickTxt=currentUser.user_metadata?.nickname||currentUser.email;
  else{
    const arr = await rest("GET","/rest/v1/profiles",{ query:{ select:"nickname", id:`eq.${userId}` } });
    if(arr?.[0]?.nickname) nickTxt=arr[0].nickname;
  }
  profileName.textContent=nickTxt; profileAvatar.textContent=(nickTxt[0]||"?").toUpperCase();

  const mine = allGames.filter(g=>g.creator_id===userId);
  likesCount.textContent = mine.reduce((a,b)=>a+(b.likes||0),0);
  visitsCount.textContent = mine.reduce((a,b)=>a+(b.visits||0),0);

  userGamesGrid.innerHTML="";
  if(!mine.length){
    const txt=(currentUser && currentUser.id===userId)?"No has subido ning√∫n juego.":"No ha subido ning√∫n juego.";
    const noDiv=document.createElement("div"); noDiv.className="metaMuted"; noDiv.style.textAlign="center"; noDiv.style.padding="12px"; noDiv.textContent=txt;
    userGamesGrid.appendChild(noDiv);
  }else{
    mine.forEach((g)=>{
      const card=document.createElement("div"); card.className="gameCard";
      card.innerHTML=`
        <div class="cardTitle">${escapeHtml(g.title||"Sin t√≠tulo")}</div>
        <iframe class="cardPreview" sandbox="allow-scripts" loading="lazy"></iframe>
        <div class="metaMuted">‚ù§Ô∏è ${g.likes||0} ¬∑ üëÅÔ∏è ${g.visits||0}</div>`;
      card.querySelector("iframe").srcdoc = srcdocSafe(g.code);
      card.onclick=()=>openGame(g.id);
      userGamesGrid.appendChild(card);
    });
  }
}
backHomeBtn.onclick=()=>setView("home");
backHomeFromGame.onclick=()=>setView("home");

/* ========= Upload ========= */
const MAX_BYTES=1048576;
fab.onclick=()=>openUpload();
function updateFab(){ fab.classList.toggle("hidden", !currentUser || homeView.classList.contains("hidden")); }
function openUpload(){
  if(!currentUser){ alert("Inicia sesi√≥n para subir juegos."); return; }
  setView("upload");
  gameNameIn.value=""; gameDescIn.value=""; codeEditor.value="";
  codePreview.srcdoc=""; updateByteCounter(); tabTo("edit");
}
cancelUploadBtn.onclick=()=>setView("home");
tabEdit.onclick=()=>tabTo("edit");
tabPreview.onclick=()=>tabTo("preview");
function tabTo(w){ if(w==="edit"){tabEdit.classList.add("active");tabPreview.classList.remove("active");codeEditor.classList.remove("hidden");codePreview.classList.add("hidden");}
else{tabPreview.classList.add("active");tabEdit.classList.remove("active");codeEditor.classList.add("hidden");codePreview.classList.remove("hidden");codePreview.srcdoc=srcdocSafe(codeEditor.value);} }
function updateByteCounter(){ const n=bytesOf(codeEditor.value); byteCounter.textContent=`${n.toLocaleString()} / ${MAX_BYTES.toLocaleString()} bytes`; }
codeEditor.addEventListener("input",updateByteCounter);

submitGameBtn.onclick=async()=>{
  if(!currentUser){ alert("Inicia sesi√≥n."); return; }
  const title=nic(gameNameIn.value), description=nic(gameDescIn.value), code=codeEditor.value;
  if(!title||!code){ alert("Pon al menos nombre y c√≥digo."); return; }
  if(bytesOf(code)>MAX_BYTES){ alert("Tu juego supera 1 MB."); return; }
  try{
    const inserted = await rest("POST","/rest/v1/games",{ body:{ creator_id:currentUser.id, title, description, code, likes:0, dislikes:0, visits:0 } });
    const game = inserted?.[0];
    if(game){
      game.creator_name = currentUser.user_metadata?.nickname||currentUser.email;
      allGames.unshift(game);
      renderHome();
      openGame(game.id);
    }
  }catch(e){ alert("No se pudo subir el juego. Revisa RLS: "+(e.message||e)); }
};

/* ========= Init ========= */
(async function init(){
  loadSession();
  if(session){
    try{
      await ensureFreshToken();
      currentUser = session.user;
      const nick=currentUser?.user_metadata?.nickname||currentUser?.email||"Usuario";
      userAvatar.textContent=(nick[0]||"?").toUpperCase();
      userNameTop.textContent=nick;
      showApp();
      await loadGames();
    }catch{
      clearSession(); showAuth();
    }
  }else{
    showAuth();
  }
  const obs=new MutationObserver(updateFab); obs.observe(homeView,{attributes:true,attributeFilter:["class"]});
  ["viewProfileBtn","logoutBtn","deleteBtn"].forEach(id=>{ const el=$(id); if(el) el.addEventListener("click",()=>closeDropdown()); });
})();
</script>
</body>
</html>
